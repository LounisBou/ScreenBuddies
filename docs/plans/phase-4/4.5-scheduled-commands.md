# Phase 4.5: Scheduled Commands

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create scheduled commands to close expired elections and archive old ones.

**Architecture:** Artisan commands run on schedule, update election status.

**Tech Stack:** Laravel Console Commands, Scheduler

**Prerequisites:** Phase 4.4 complete

**Reference:** `docs/plans/phase-4-voting-and-results.md` Task 5

---

## Task 1: Write Command Tests

**Step 1: Create test file**

Create `backend/tests/Feature/Commands/ElectionCommandsTest.php`:
```php
<?php

use App\Models\Election;
use App\Models\MediaType;
use App\Enums\ElectionStatus;
use Illuminate\Support\Carbon;

beforeEach(function () {
    MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('close expired elections command', function () {
    // Past deadline election
    $expiredElection = Election::factory()->create([
        'status' => ElectionStatus::VOTING,
        'deadline' => Carbon::now()->subHour(),
        'election_date' => Carbon::now()->addDay(),
    ]);

    // Future deadline election
    $activeElection = Election::factory()->create([
        'status' => ElectionStatus::VOTING,
        'deadline' => Carbon::now()->addHour(),
        'election_date' => Carbon::now()->addDays(2),
    ]);

    $this->artisan('election:close-expired')
        ->assertSuccessful();

    expect($expiredElection->fresh()->status)->toBe(ElectionStatus::ENDED);
    expect($activeElection->fresh()->status)->toBe(ElectionStatus::VOTING);
});

test('archive old elections command', function () {
    // Past election date (> 24h)
    $oldElection = Election::factory()->create([
        'status' => ElectionStatus::ENDED,
        'election_date' => Carbon::now()->subDays(2),
        'deadline' => Carbon::now()->subDays(3),
    ]);

    // Recent election
    $recentElection = Election::factory()->create([
        'status' => ElectionStatus::ENDED,
        'election_date' => Carbon::now()->subHours(12),
        'deadline' => Carbon::now()->subHours(13),
    ]);

    $this->artisan('election:archive')
        ->assertSuccessful();

    expect($oldElection->fresh()->status)->toBe(ElectionStatus::ARCHIVED);
    expect($recentElection->fresh()->status)->toBe(ElectionStatus::ENDED);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Feature/Commands/ElectionCommandsTest.php
```
Expected: FAIL

**Step 3: Commit test**

```bash
git add backend/tests/Feature/Commands/ElectionCommandsTest.php
git commit -m "test: add election command tests"
```

---

## Task 2: Create CloseExpiredElections Command

**Step 1: Create command**

Create `backend/app/Console/Commands/CloseExpiredElections.php`:
```php
<?php

namespace App\Console\Commands;

use App\Enums\ElectionStatus;
use App\Models\Election;
use Illuminate\Console\Command;

class CloseExpiredElections extends Command
{
    protected $signature = 'election:close-expired';
    protected $description = 'Close elections that have passed their deadline';

    public function handle(): int
    {
        $elections = Election::where('status', ElectionStatus::VOTING)
            ->where('deadline', '<', now())
            ->get();

        $count = 0;
        foreach ($elections as $election) {
            $election->update(['status' => ElectionStatus::ENDED]);
            $count++;
            $this->info("Closed election: {$election->title}");
        }

        $this->info("Closed $count elections.");

        return Command::SUCCESS;
    }
}
```

**Step 2: Commit**

```bash
git add backend/app/Console/Commands/CloseExpiredElections.php
git commit -m "feat: add CloseExpiredElections command"
```

---

## Task 3: Create ArchiveOldElections Command

**Step 1: Create command**

Create `backend/app/Console/Commands/ArchiveOldElections.php`:
```php
<?php

namespace App\Console\Commands;

use App\Enums\ElectionStatus;
use App\Models\Election;
use Illuminate\Console\Command;

class ArchiveOldElections extends Command
{
    protected $signature = 'election:archive';
    protected $description = 'Archive elections 24 hours after election date';

    public function handle(): int
    {
        $archiveAfterHours = config('election.archive_after_hours', 24);

        $elections = Election::where('status', ElectionStatus::ENDED)
            ->where('election_date', '<', now()->subHours($archiveAfterHours))
            ->get();

        $count = 0;
        foreach ($elections as $election) {
            $election->update(['status' => ElectionStatus::ARCHIVED]);
            $count++;
            $this->info("Archived election: {$election->title}");
        }

        $this->info("Archived $count elections.");

        return Command::SUCCESS;
    }
}
```

**Step 2: Commit**

```bash
git add backend/app/Console/Commands/ArchiveOldElections.php
git commit -m "feat: add ArchiveOldElections command"
```

---

## Task 4: Register Scheduler

**Step 1: Update scheduler**

Edit `backend/routes/console.php`:
```php
<?php

use Illuminate\Support\Facades\Schedule;

Schedule::command('election:close-expired')->everyMinute();
Schedule::command('election:archive')->hourly();
```

**Step 2: Run tests**

```bash
php artisan test tests/Feature/Commands/ElectionCommandsTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/routes/console.php
git commit -m "chore: schedule election lifecycle commands"
```

---

## Commands Overview

| Command | Schedule | Description |
|---------|----------|-------------|
| election:close-expired | Every minute | Close elections past deadline |
| election:archive | Hourly | Archive elections 24h after election_date |

---

## Phase 4.5 Completion Checklist

- [ ] Command tests written (TDD)
- [ ] CloseExpiredElections checks deadline
- [ ] ArchiveOldElections checks election_date
- [ ] Uses config('election.archive_after_hours')
- [ ] Commands scheduled
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 4.6: Finalization** for full test suite.
