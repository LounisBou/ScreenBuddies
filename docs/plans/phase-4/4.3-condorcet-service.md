# Phase 4.3: CondorcetService

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement Ranked Pairs (Tideman) algorithm with confidence-weighting for election results.

**Architecture:** Service aggregates votes from Voter.votes JSON, builds preference graph, calculates rankings.

**Tech Stack:** Laravel Service Layer, Cache

**Prerequisites:** Phase 4.2 complete

**Reference:** `docs/plans/phase-4-voting-and-results.md` Task 3, `docs/condorcet-implementation.md`

---

## Algorithm Overview

**Ranked Pairs (Tideman):**
1. Build preference graph from all voters' JSON votes
2. Calculate pairwise win margins
3. Sort edges by strength (confidence-weighted)
4. Lock edges without creating cycles
5. Calculate scores based on locked graph

**Confidence Weighting:**
- Statistical reliability check using 95% confidence interval
- Pairs where CI crosses 0.5 are excluded (unreliable)
- Laplace smoothing (Alpha=1) for edge strength

---

## Task 1: Write CondorcetService Tests

**Step 1: Create test file**

Create `backend/tests/Unit/Services/Election/CondorcetServiceTest.php`:
```php
<?php

use App\Models\User;
use App\Models\Election;
use App\Models\Candidate;
use App\Models\Voter;
use App\Models\MediaType;
use App\Services\Election\CondorcetService;

beforeEach(function () {
    $this->mediaType = MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('builds preference graph from voter JSON votes', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create(['media_type_id' => $this->mediaType->id]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);
    $c3 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:3', 'title' => 'Movie 3']);

    $voter = Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [
            "{$c1->id}_{$c2->id}" => $c1->id,  // C1 beats C2
            "{$c1->id}_{$c3->id}" => $c1->id,  // C1 beats C3
            "{$c2->id}_{$c3->id}" => $c2->id,  // C2 beats C3
        ],
        'duel_count' => 3,
    ]);

    $service = new CondorcetService();
    $graph = $service->buildPreferenceGraph($election);

    expect($graph[$c1->id][$c2->id])->toBe(1);
    expect($graph[$c1->id][$c3->id])->toBe(1);
    expect($graph[$c2->id][$c3->id])->toBe(1);
    expect($graph[$c2->id][$c1->id])->toBe(0);
});

test('aggregates votes from multiple voters', function () {
    // ... (see full code in main plan)
});

test('calculates rankings correctly using Ranked Pairs', function () {
    // Create 10 voters with strong, clear ranking: C1 > C2 > C3
    // ... (see full code in main plan)
});

test('ignores pairs that are not statistically reliable', function () {
    // With only a 2-1 margin, confidence interval includes 0.5
    // ... (see full code in main plan)
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Unit/Services/Election/CondorcetServiceTest.php
```
Expected: FAIL

**Step 3: Commit test**

```bash
git add backend/tests/Unit/Services/Election/CondorcetServiceTest.php
git commit -m "test: add CondorcetService tests"
```

---

## Task 2: Implement CondorcetService

**Step 1: Create service**

Create `backend/app/Services/Election/CondorcetService.php` with full implementation from main plan including:
- `isPairReliable()` - Check if CI excludes 0.5
- `buildPreferenceGraph()` - Aggregate from Voter.votes JSON
- `buildRankedPairsEdges()` - Create edges with strength
- `createsCycle()` - DFS cycle detection
- `calculateRankings()` - Full Ranked Pairs algorithm
- `getWinners()` - Return top K by winner_count

**Step 2: Run tests**

```bash
php artisan test tests/Unit/Services/Election/CondorcetServiceTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/app/Services/Election/CondorcetService.php
git commit -m "feat: add CondorcetService with Ranked Pairs algorithm"
```

---

## Key Constants

```php
private const ALPHA = 1;           // Beta prior (Laplace smoothing)
private const Z_CONFIDENCE = 1.96; // z-score for 95% confidence
```

---

## Key Methods

| Method | Description |
|--------|-------------|
| buildPreferenceGraph() | Aggregates all voters' JSON votes |
| computePairwiseStats() | Returns {wins_ij, wins_ji, total} per pair |
| calculateRankings() | Full Ranked Pairs with caching |
| getWinners() | Returns top K candidates |
| clearCache() | Invalidates ranking cache |

---

## Phase 4.3 Completion Checklist

- [ ] Tests written (TDD)
- [ ] buildPreferenceGraph() aggregates JSON votes
- [ ] isPairReliable() using 95% CI rule
- [ ] buildRankedPairsEdges() with Laplace smoothing
- [ ] createsCycle() DFS implementation
- [ ] calculateRankings() with proper sorting
- [ ] Results cached for 5 minutes
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 4.4: Results Controller** for API endpoint.
