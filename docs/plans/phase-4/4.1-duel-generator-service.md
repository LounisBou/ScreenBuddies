# Phase 4.1: DuelGeneratorService

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create service to generate duel pairs and record votes in Voter.votes JSON.

**Architecture:** Service reads/writes Voter.votes JSON blob, tracks progress, generates unvoted pairs.

**Tech Stack:** Laravel Service Layer, JSON storage

**Prerequisites:** Phase 3 complete

**Reference:** `docs/plans/phase-4-voting-and-results.md` Task 1

---

## Data Model

```
Voter.votes JSON format: {"1_2": 1, "1_3": 3, "2_3": null, ...}
Key = "{smaller_id}_{larger_id}", Value = winner's candidate ID or null (skip)
```

---

## Task 1: Write DuelGeneratorService Tests

**Step 1: Create test file**

Create `backend/tests/Unit/Services/Election/DuelGeneratorServiceTest.php`:
```php
<?php

use App\Models\User;
use App\Models\Election;
use App\Models\Candidate;
use App\Models\Voter;
use App\Models\MediaType;
use App\Services\Election\DuelGeneratorService;

beforeEach(function () {
    $this->mediaType = MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('generates next duel for voter', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create(['media_type_id' => $this->mediaType->id]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);
    $c3 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:3', 'title' => 'Movie 3']);

    $voter = Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [],
    ]);

    $service = new DuelGeneratorService();
    $duel = $service->getNextDuel($voter);

    expect($duel)->not->toBeNull();
    expect($duel['candidate_a'])->toBeInstanceOf(Candidate::class);
    expect($duel['candidate_b'])->toBeInstanceOf(Candidate::class);
});

test('returns null when all duels completed', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create(['media_type_id' => $this->mediaType->id]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);

    // Create voter with completed vote in JSON
    $voter = Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => ["{$c1->id}_{$c2->id}" => $c1->id],
        'duel_count' => 1,
    ]);

    $service = new DuelGeneratorService();
    $duel = $service->getNextDuel($voter);

    expect($duel)->toBeNull();
});

test('calculates progress correctly', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create(['media_type_id' => $this->mediaType->id]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);
    $c3 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:3', 'title' => 'Movie 3']);

    $voter = Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [],
        'duel_count' => 0,
    ]);

    $service = new DuelGeneratorService();
    $progress = $service->getProgress($voter);

    expect($progress['completed'])->toBe(0);
    expect($progress['total'])->toBe(3); // 3 candidates = 3 pairs
    expect($progress['percentage'])->toBe(0.0);
});

test('records vote in voter JSON', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create(['media_type_id' => $this->mediaType->id]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);

    $voter = Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [],
        'duel_count' => 0,
    ]);

    $service = new DuelGeneratorService();
    $service->recordVote($voter, $c1->id, $c2->id, $c1->id);

    $voter->refresh();
    expect($voter->votes)->toHaveKey("{$c1->id}_{$c2->id}");
    expect($voter->votes["{$c1->id}_{$c2->id}"])->toBe($c1->id);
    expect($voter->duel_count)->toBe(1);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Unit/Services/Election/DuelGeneratorServiceTest.php
```
Expected: FAIL (class not found)

**Step 3: Commit test**

```bash
git add backend/tests/Unit/Services/Election/DuelGeneratorServiceTest.php
git commit -m "test: add DuelGeneratorService tests"
```

---

## Task 2: Implement DuelGeneratorService

**Step 1: Create service**

Create `backend/app/Services/Election/DuelGeneratorService.php` with full implementation from `docs/plans/phase-4-voting-and-results.md` Task 1.

**Step 2: Run tests**

```bash
php artisan test tests/Unit/Services/Election/DuelGeneratorServiceTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/app/Services/Election/DuelGeneratorService.php
git commit -m "feat: add DuelGeneratorService with JSON vote storage"
```

---

## Key Methods

| Method | Description |
|--------|-------------|
| getNextDuel() | Returns random unvoted pair or null |
| getProgress() | Returns {completed, total, percentage} |
| recordVote() | Writes to Voter.votes JSON, updates duel_count |
| hasVoted() | Checks if pair exists in JSON |
| isComplete() | Returns true if all pairs voted |

---

## Phase 4.1 Completion Checklist

- [ ] Tests written (TDD)
- [ ] getNextDuel() finds unvoted pairs
- [ ] Pair key normalized (smaller_id first)
- [ ] recordVote() stores in JSON
- [ ] getProgress() calculates n*(n-1)/2
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 4.2: Voting Controller** for API endpoints.
