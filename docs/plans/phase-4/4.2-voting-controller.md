# Phase 4.2: Voting Controller

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create voting API endpoints for getting next duel, casting votes, and viewing history.

**Architecture:** Controller uses DuelGeneratorService, validates candidates, stores votes in JSON.

**Tech Stack:** Laravel Controllers, Form Requests

**Prerequisites:** Phase 4.1 complete

**Reference:** `docs/plans/phase-4-voting-and-results.md` Task 2

---

## Task 1: Write Voting Feature Tests

**Step 1: Create test file**

Create `backend/tests/Feature/Voting/VotingTest.php`:
```php
<?php

use App\Models\User;
use App\Models\Election;
use App\Models\Candidate;
use App\Models\Voter;
use App\Models\MediaType;
use App\Enums\ElectionStatus;
use Laravel\Sanctum\Sanctum;

beforeEach(function () {
    $this->mediaType = MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('voter can get next duel', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create([
        'media_type_id' => $this->mediaType->id,
        'status' => ElectionStatus::VOTING,
    ]);

    Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);

    Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [],
    ]);

    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}/vote/next");

    $response->assertStatus(200)
        ->assertJsonStructure([
            'data' => [
                'candidate_a' => ['id', 'title'],
                'candidate_b' => ['id', 'title'],
                'progress' => ['completed', 'total', 'percentage'],
            ],
        ]);
});

test('voter can cast vote', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create([
        'media_type_id' => $this->mediaType->id,
        'status' => ElectionStatus::VOTING,
    ]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);

    $voter = Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [],
    ]);

    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->postJson("/api/v1/elections/{$election->uuid}/vote", [
            'candidate_a_id' => $c1->id,
            'candidate_b_id' => $c2->id,
            'winner_id' => $c1->id,
        ]);

    $response->assertStatus(200)
        ->assertJsonPath('data.voted', true);

    $voter->refresh();
    expect($voter->votes)->toHaveKey("{$c1->id}_{$c2->id}");
});

test('cannot vote on same pair twice', function () {
    // ... (see full code in main plan)
});

test('cannot vote on ended election', function () {
    // ... (see full code in main plan)
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Feature/Voting/VotingTest.php
```
Expected: FAIL

**Step 3: Commit test**

```bash
git add backend/tests/Feature/Voting/VotingTest.php
git commit -m "test: add voting feature tests"
```

---

## Task 2: Create Supporting Files

**Step 1: Create CastVoteRequest**

Create `backend/app/Http/Requests/Voting/CastVoteRequest.php`:
```php
<?php

namespace App\Http\Requests\Voting;

use Illuminate\Foundation\Http\FormRequest;

class CastVoteRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'candidate_a_id' => ['required', 'integer'],
            'candidate_b_id' => ['required', 'integer', 'different:candidate_a_id'],
            'winner_id' => ['nullable', 'integer'],  // null = skip
        ];
    }
}
```

**Step 2: Commit**

```bash
git add backend/app/Http/Requests/Voting/CastVoteRequest.php
git commit -m "feat: add CastVoteRequest"
```

---

## Task 3: Create VotingController

**Step 1: Create controller**

Create `backend/app/Http/Controllers/Api/V1/VotingController.php` with full implementation from main plan:
- next() - Get next duel
- vote() - Cast vote or skip
- history() - View past votes

**Step 2: Commit**

```bash
git add backend/app/Http/Controllers/Api/V1/VotingController.php
git commit -m "feat: add VotingController"
```

---

## Task 4: Add Routes

**Step 1: Add voting routes**

Add to `backend/routes/api.php`:
```php
use App\Http\Controllers\Api\V1\VotingController;

// Inside auth:sanctum middleware:
Route::get('elections/{uuid}/vote/next', [VotingController::class, 'next']);
Route::post('elections/{uuid}/vote', [VotingController::class, 'vote']);
Route::get('elections/{uuid}/vote/history', [VotingController::class, 'history']);
```

**Step 2: Run tests**

```bash
php artisan test tests/Feature/Voting/VotingTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/routes/api.php
git commit -m "feat: add voting routes"
```

---

## API Endpoints Created

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/v1/elections/{uuid}/vote/next | Get next duel pair |
| POST | /api/v1/elections/{uuid}/vote | Cast vote (winner_id or null to skip) |
| GET | /api/v1/elections/{uuid}/vote/history | View vote history |

---

## Phase 4.2 Completion Checklist

- [ ] Feature tests written (TDD)
- [ ] CastVoteRequest with validation
- [ ] VotingController with next/vote/history
- [ ] Validates candidates belong to election
- [ ] Validates winner is one of the pair
- [ ] Prevents duplicate votes
- [ ] Blocks voting on ended elections
- [ ] Routes added
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 4.3: CondorcetService** for ranking algorithm.
