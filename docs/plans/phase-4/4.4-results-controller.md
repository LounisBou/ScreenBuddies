# Phase 4.4: Results Controller

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create API endpoint to retrieve election results with rankings and statistics.

**Architecture:** Controller uses CondorcetService, only available for ENDED/ARCHIVED elections.

**Tech Stack:** Laravel Controllers, API Resources

**Prerequisites:** Phase 4.3 complete

**Reference:** `docs/plans/phase-4-voting-and-results.md` Task 4

---

## Task 1: Write Results Feature Tests

**Step 1: Create test file**

Create `backend/tests/Feature/Election/ResultsTest.php`:
```php
<?php

use App\Models\User;
use App\Models\Election;
use App\Models\Candidate;
use App\Models\Voter;
use App\Models\MediaType;
use App\Enums\ElectionStatus;
use Laravel\Sanctum\Sanctum;

beforeEach(function () {
    $this->mediaType = MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('voter can get results after election ends', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create([
        'media_type_id' => $this->mediaType->id,
        'status' => ElectionStatus::ENDED,
        'winner_count' => 1,
    ]);

    $c1 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:1', 'title' => 'Movie 1']);
    $c2 = Candidate::create(['election_id' => $election->id, 'external_id' => 'tmdb:2', 'title' => 'Movie 2']);

    Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => ["{$c1->id}_{$c2->id}" => $c1->id],
        'duel_count' => 1,
    ]);

    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}/results");

    $response->assertStatus(200)
        ->assertJsonStructure([
            'data' => [
                'winners' => [
                    '*' => ['rank', 'candidate', 'stats'],
                ],
                'full_ranking',
                'total_duels',
            ],
        ]);
});

test('cannot get results while voting', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create([
        'media_type_id' => $this->mediaType->id,
        'status' => ElectionStatus::VOTING,
    ]);

    Voter::create([
        'election_id' => $election->id,
        'user_id' => $user->id,
        'joined_at' => now(),
        'votes' => [],
    ]);

    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}/results");

    $response->assertStatus(400)
        ->assertJsonPath('error.code', 'ELECTION_NOT_ENDED');
});

test('non-participant cannot view results', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create([
        'media_type_id' => $this->mediaType->id,
        'status' => ElectionStatus::ENDED,
    ]);

    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}/results");

    $response->assertStatus(403);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Feature/Election/ResultsTest.php
```
Expected: FAIL

**Step 3: Commit test**

```bash
git add backend/tests/Feature/Election/ResultsTest.php
git commit -m "test: add results feature tests"
```

---

## Task 2: Create ResultsController

**Step 1: Create controller**

Create `backend/app/Http/Controllers/Api/V1/ResultsController.php`:
```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Enums\ElectionStatus;
use App\Exceptions\ApiException;
use App\Http\Controllers\Controller;
use App\Http\Resources\CandidateResource;
use App\Models\Election;
use App\Models\Voter;
use App\Services\Election\CondorcetService;
use Illuminate\Http\JsonResponse;

class ResultsController extends Controller
{
    public function __construct(
        private CondorcetService $condorcetService
    ) {}

    public function show(string $uuid): JsonResponse
    {
        $election = Election::where('uuid', $uuid)
            ->with(['voters.user'])
            ->firstOrFail();

        $this->authorizeView($election);

        if (!in_array($election->status, [ElectionStatus::ENDED, ElectionStatus::ARCHIVED])) {
            throw new ApiException(
                'ELECTION_NOT_ENDED',
                'Results are only available after voting ends.',
                400
            );
        }

        $winners = $this->condorcetService->getWinners($election);
        $fullRanking = $this->condorcetService->calculateRankings($election);

        $totalDuels = $election->voters->sum('duel_count');
        $totalPossible = $this->calculateTotalPairs(
            $election->candidates()->where('is_approved', true)->count()
        );

        $voterParticipation = $election->voters->map(function ($voter) use ($totalPossible) {
            return [
                'voter' => ['display_name' => $voter->user->display_name],
                'duels_completed' => $voter->duel_count,
                'percentage' => $totalPossible > 0
                    ? round(($voter->duel_count / $totalPossible) * 100, 1)
                    : 0,
            ];
        });

        return response()->json([
            'data' => [
                'winners' => $this->formatRankings($winners),
                'full_ranking' => $this->formatRankings($fullRanking),
                'total_duels' => $totalDuels,
                'voter_participation' => $voterParticipation,
            ],
        ]);
    }

    private function formatRankings(array $rankings): array
    {
        return array_map(fn ($r) => [
            'rank' => $r['rank'],
            'candidate' => new CandidateResource($r['candidate']),
            'stats' => $r['stats'],
        ], $rankings);
    }

    private function calculateTotalPairs(int $n): int
    {
        return (int) ($n * ($n - 1) / 2);
    }

    private function authorizeView(Election $election): void
    {
        $user = auth()->user();

        if ($election->maestro_id === $user->id) {
            return;
        }

        if (!$election->voters()->where('user_id', $user->id)->exists()) {
            throw new ApiException('FORBIDDEN', 'You do not have access to this election.', 403);
        }
    }
}
```

**Step 2: Commit**

```bash
git add backend/app/Http/Controllers/Api/V1/ResultsController.php
git commit -m "feat: add ResultsController"
```

---

## Task 3: Add Route

**Step 1: Add results route**

Add to `backend/routes/api.php`:
```php
use App\Http\Controllers\Api\V1\ResultsController;

// Inside auth:sanctum middleware:
Route::get('elections/{uuid}/results', [ResultsController::class, 'show']);
```

**Step 2: Run tests**

```bash
php artisan test tests/Feature/Election/ResultsTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/routes/api.php
git commit -m "feat: add results route"
```

---

## Response Structure

```json
{
  "data": {
    "winners": [
      {
        "rank": 1,
        "candidate": { "id": 1, "title": "Movie 1", ... },
        "stats": { "wins": 20, "losses": 5, "win_rate": 80.0 }
      }
    ],
    "full_ranking": [...],
    "total_duels": 150,
    "voter_participation": [
      { "voter": { "display_name": "User1" }, "duels_completed": 15, "percentage": 100 }
    ]
  }
}
```

---

## Phase 4.4 Completion Checklist

- [ ] Feature tests written (TDD)
- [ ] ResultsController created
- [ ] Only shows results for ENDED/ARCHIVED
- [ ] Returns winners and full_ranking
- [ ] Includes voter participation stats
- [ ] Authorization check (maestro or voter)
- [ ] Route added
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 4.5: Scheduled Commands** for election lifecycle.
