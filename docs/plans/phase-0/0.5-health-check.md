# Phase 0.5: Health Check Endpoint

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a health check endpoint that verifies database and Redis connectivity.

**Architecture:** Single endpoint that tests all critical dependencies and returns structured status.

**Tech Stack:** Laravel Controller, PostgreSQL, Redis

**Prerequisites:**
- Phase 0.4 completed (Sentry monitoring)

**Reference:** `docs/specifications/03-backend-architecture.md`, `docs/specifications/05-api-endpoints.md`

---

## Task 1: Create API Controllers Directory

**Files:**
- Create: `backend/app/Http/Controllers/Api/` directory

**Step 1: Create Api directory**

Run:
```bash
mkdir -p backend/app/Http/Controllers/Api
```

**Step 2: Verify directory exists**

Run:
```bash
ls -la backend/app/Http/Controllers/
```

Expected: `Api` directory listed

---

## Task 2: Write Health Check Test (TDD)

**Files:**
- Create: `backend/tests/Feature/HealthCheckTest.php`

**Step 1: Create the test file**

Create `backend/tests/Feature/HealthCheckTest.php`:
```php
<?php

test('health check returns ok when services are healthy', function () {
    $response = $this->getJson('/api/health');

    $response->assertStatus(200)
        ->assertJson([
            'status' => 'ok',
        ])
        ->assertJsonStructure([
            'status',
            'checks' => ['database', 'redis'],
            'timestamp',
        ]);
});

test('health check database check returns boolean', function () {
    $response = $this->getJson('/api/health');

    $response->assertStatus(200);

    $data = $response->json();
    expect($data['checks']['database'])->toBeBool();
});

test('health check redis check returns boolean', function () {
    $response = $this->getJson('/api/health');

    $response->assertStatus(200);

    $data = $response->json();
    expect($data['checks']['redis'])->toBeBool();
});

test('health check timestamp is valid ISO 8601', function () {
    $response = $this->getJson('/api/health');

    $response->assertStatus(200);

    $data = $response->json();
    $timestamp = \DateTime::createFromFormat(\DateTime::ATOM, $data['timestamp']);
    expect($timestamp)->not->toBeFalse();
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd backend && php artisan test tests/Feature/HealthCheckTest.php
```

Expected: FAIL - route not defined

---

## Task 3: Create HealthController

**Files:**
- Create: `backend/app/Http/Controllers/Api/HealthController.php`

**Step 1: Create HealthController**

Create `backend/app/Http/Controllers/Api/HealthController.php`:
```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\DB;

class HealthController extends Controller
{
    public function __invoke(): JsonResponse
    {
        $checks = [
            'database' => $this->checkDatabase(),
            'redis' => $this->checkRedis(),
        ];

        $healthy = $checks['database'] && $checks['redis'];
        $status = $healthy ? 'ok' : 'degraded';

        return response()->json([
            'status' => $status,
            'checks' => $checks,
            'timestamp' => now()->toIso8601String(),
        ], $healthy ? 200 : 503);
    }

    private function checkDatabase(): bool
    {
        try {
            DB::select('SELECT 1');
            return true;
        } catch (\Exception $e) {
            return false;
        }
    }

    private function checkRedis(): bool
    {
        try {
            Cache::store('redis')->put('health_check', true, 10);
            return Cache::store('redis')->get('health_check') === true;
        } catch (\Exception $e) {
            return false;
        }
    }
}
```

**Step 2: Verify file created**

Run:
```bash
ls -la backend/app/Http/Controllers/Api/HealthController.php
```

Expected: File exists

---

## Task 4: Add Health Route

**Files:**
- Modify: `backend/routes/api.php`

**Step 1: Read current api.php**

Read `backend/routes/api.php` to see current contents.

**Step 2: Add health check route**

Update `backend/routes/api.php`:
```php
<?php

use App\Http\Controllers\Api\HealthController;
use Illuminate\Support\Facades\Route;

// Health check (no auth required)
Route::get('health', HealthController::class);
```

---

## Task 5: Run Tests to Verify Implementation

**Files:** None

**Step 1: Run health check tests**

Run:
```bash
cd backend && php artisan test tests/Feature/HealthCheckTest.php
```

Expected: All 4 tests PASS

**Step 2: Run all tests to ensure no regressions**

Run:
```bash
cd backend && composer test
```

Expected: All tests pass

---

## Task 6: Manual Testing

**Files:** None

**Step 1: Start server**

Run:
```bash
cd backend && php artisan serve &
```

**Step 2: Test health endpoint**

Run:
```bash
curl -s http://localhost:8000/api/health | jq .
```

Expected:
```json
{
  "status": "ok",
  "checks": {
    "database": true,
    "redis": true
  },
  "timestamp": "2024-xx-xxTxx:xx:xx+00:00"
}
```

**Step 3: Stop server**

Run:
```bash
pkill -f "php artisan serve"
```

---

## Task 7: Run Static Analysis

**Files:** None

**Step 1: Run PHPStan**

Run:
```bash
cd backend && composer analyse
```

Expected: No errors in HealthController

**Step 2: Run PHP CS Fixer**

Run:
```bash
cd backend && composer format
```

Expected: File formatted if needed

---

## Task 8: Commit Health Check

**Files:**
- `backend/app/Http/Controllers/Api/HealthController.php`
- `backend/routes/api.php`
- `backend/tests/Feature/HealthCheckTest.php`

**Step 1: Check git status**

Run:
```bash
git status
```

**Step 2: Stage health check files**

Run:
```bash
git add backend/app/Http/Controllers/Api/ backend/routes/api.php backend/tests/Feature/HealthCheckTest.php
```

**Step 3: Create commit**

Run:
```bash
git commit -m "$(cat <<'EOF'
feat: add health check endpoint

- GET /api/health returns service status
- Checks database and Redis connectivity
- Returns 200 (ok) or 503 (degraded)
- Includes timestamp in ISO 8601 format
- Full test coverage
EOF
)"
```

**Step 4: Verify commit**

Run:
```bash
git log --oneline -1
```

Expected: Commit message "feat: add health check endpoint"

---

## Phase 0.5 Completion Checklist

- [ ] Api controllers directory created
- [ ] Health check tests written first (TDD)
- [ ] Tests initially fail (no route)
- [ ] HealthController created
- [ ] Database check implemented
- [ ] Redis check implemented
- [ ] Health route added to api.php
- [ ] All tests pass
- [ ] Manual testing verified
- [ ] Static analysis passed
- [ ] Code formatted
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 0.6: Laravel Telescope** for local debugging tools.
