# Phase 0.3: CI/CD Pipeline Setup

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Configure GitHub Actions workflow for automated testing, linting, and code analysis.

**Architecture:** GitHub Actions with PostgreSQL and Redis service containers for integration testing.

**Tech Stack:** GitHub Actions, Docker services (postgres:16, redis:7)

**Prerequisites:**
- Phase 0.2 completed (development tools installed)
- GitHub repository set up

**Reference:** `docs/specifications/03-backend-architecture.md`

---

## Task 1: Create GitHub Workflows Directory

**Files:**
- Create: `.github/workflows/` directory

**Step 1: Create directory structure**

Run:
```bash
mkdir -p /Users/lounis/dev/ScreenBuddies/.github/workflows
```

**Step 2: Verify directory exists**

Run:
```bash
ls -la /Users/lounis/dev/ScreenBuddies/.github/
```

Expected: `workflows` directory listed

---

## Task 2: Create CI Workflow File

**Files:**
- Create: `.github/workflows/ci.yml`

**Step 1: Create CI workflow**

Create `.github/workflows/ci.yml`:
```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testing
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pgsql, redis, mbstring, xml, curl, zip
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: composer-

      - name: Install dependencies
        working-directory: backend
        run: composer install --prefer-dist --no-progress

      - name: Copy .env
        working-directory: backend
        run: cp .env.example .env

      - name: Generate key
        working-directory: backend
        run: php artisan key:generate

      - name: Run static analysis
        working-directory: backend
        run: composer analyse
        continue-on-error: true

      - name: Check code style
        working-directory: backend
        run: composer format:check
        continue-on-error: true

      - name: Run tests
        working-directory: backend
        env:
          DB_CONNECTION: pgsql
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: testing
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
        run: composer test

  flutter:
    name: Flutter Tests
    runs-on: ubuntu-latest
    # Skip if app/ directory doesn't exist yet
    if: hashFiles('app/pubspec.yaml') != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        working-directory: app
        run: flutter pub get

      - name: Analyze code
        working-directory: app
        run: flutter analyze

      - name: Run tests
        working-directory: app
        run: flutter test
```

**Step 2: Verify file syntax**

Run:
```bash
cat .github/workflows/ci.yml | head -20
```

Expected: Valid YAML content

---

## Task 3: Update .env.example for CI

**Files:**
- Modify: `backend/.env.example`

**Step 1: Read current .env.example**

Read `backend/.env.example` to see current contents.

**Step 2: Update .env.example with all required variables**

Ensure `backend/.env.example` contains:
```env
APP_NAME=ScreenBuddies
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost:8000

LOG_CHANNEL=stack
LOG_LEVEL=debug

DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=screenbuddies
DB_USERNAME=app
DB_PASSWORD=secret

REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=null

CACHE_STORE=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis

SANCTUM_TOKEN_EXPIRATION=15
SANCTUM_REFRESH_TOKEN_EXPIRATION=10080

TMDB_API_KEY=
RAWG_API_KEY=

SENTRY_LARAVEL_DSN=
```

---

## Task 4: Test CI Workflow Locally (Optional)

**Files:** None

**Step 1: Simulate CI steps locally**

Run the same commands CI will run:

```bash
cd backend
cp .env.example .env
php artisan key:generate
composer analyse
composer format:check
composer test
```

Expected: All commands complete (analyse/format may have warnings but should not fail)

---

## Task 5: Commit CI Workflow

**Files:**
- `.github/workflows/ci.yml`
- `backend/.env.example`

**Step 1: Check git status**

Run:
```bash
git status
```

**Step 2: Stage CI files**

Run:
```bash
git add .github/ backend/.env.example
```

**Step 3: Create commit**

Run:
```bash
git commit -m "$(cat <<'EOF'
ci: add GitHub Actions workflow

- Backend job with PostgreSQL and Redis services
- PHPStan analysis and PHP CS Fixer checks
- Pest test execution
- Flutter job (conditional, when app/ exists)
EOF
)"
```

**Step 4: Verify commit**

Run:
```bash
git log --oneline -1
```

Expected: Commit message "ci: add GitHub Actions workflow"

---

## Task 6: Push and Verify Workflow

**Files:** None

**Step 1: Push to GitHub**

Run:
```bash
git push origin main
```

**Step 2: Check GitHub Actions**

Open browser: `https://github.com/YOUR_USERNAME/ScreenBuddies/actions`

Expected: CI workflow running or completed successfully

---

## Phase 0.3 Completion Checklist

- [ ] `.github/workflows/` directory created
- [ ] `ci.yml` workflow file created
- [ ] PostgreSQL service container configured
- [ ] Redis service container configured
- [ ] PHP 8.3 setup with extensions
- [ ] Composer caching configured
- [ ] Static analysis step added
- [ ] Code style check step added
- [ ] Test execution step added
- [ ] Flutter job (conditional) added
- [ ] `.env.example` updated with all variables
- [ ] Git commit created
- [ ] Workflow verified on GitHub Actions

---

## Next Sub-Phase

Proceed to **Phase 0.4: Sentry Error Monitoring** for error tracking setup.
