# Phase 0.7: Structured Logging Setup

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Configure structured JSON logging for production-ready log aggregation.

**Architecture:** Monolog with JSON formatter for production, standard format for local development.

**Tech Stack:** Laravel Logging, Monolog

**Prerequisites:**
- Phase 0.6 completed (Telescope)

**Reference:** `docs/specifications/03-backend-architecture.md`

---

## Task 1: Review Current Logging Configuration

**Files:**
- Review: `backend/config/logging.php`

**Step 1: Read current logging config**

Read `backend/config/logging.php` to understand default Laravel logging configuration.

---

## Task 2: Update Logging Configuration

**Files:**
- Modify: `backend/config/logging.php`

**Step 1: Update logging.php with JSON support**

Replace contents of `backend/config/logging.php`:
```php
<?php

use Monolog\Handler\NullHandler;
use Monolog\Handler\StreamHandler;
use Monolog\Handler\SyslogUdpHandler;
use Monolog\Processor\PsrLogMessageProcessor;

return [
    'default' => env('LOG_CHANNEL', 'stack'),

    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'),
        'trace' => false,
    ],

    'channels' => [
        'stack' => [
            'driver' => 'stack',
            'channels' => ['daily'],
            'ignore_exceptions' => false,
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => 14,
            'formatter' => env('LOG_FORMAT', 'default') === 'json'
                ? Monolog\Formatter\JsonFormatter::class
                : null,
        ],

        'stderr' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => StreamHandler::class,
            'formatter' => Monolog\Formatter\JsonFormatter::class,
            'with' => [
                'stream' => 'php://stderr',
            ],
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'syslog' => [
            'driver' => 'syslog',
            'level' => env('LOG_LEVEL', 'debug'),
            'facility' => LOG_USER,
            'replace_placeholders' => true,
        ],

        'errorlog' => [
            'driver' => 'errorlog',
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'null' => [
            'driver' => 'monolog',
            'handler' => NullHandler::class,
        ],

        'emergency' => [
            'path' => storage_path('logs/laravel.log'),
        ],
    ],
];
```

---

## Task 3: Add LOG_FORMAT Environment Variable

**Files:**
- Modify: `backend/.env.example`
- Modify: `backend/.env`

**Step 1: Add LOG_FORMAT to .env.example**

Add to `backend/.env.example`:
```env
LOG_FORMAT=default  # Use 'json' for production
```

**Step 2: Add LOG_FORMAT to local .env**

Add to `backend/.env`:
```env
LOG_FORMAT=default
```

---

## Task 4: Test Standard Logging

**Files:** None

**Step 1: Clear existing logs**

Run:
```bash
rm -f backend/storage/logs/*.log
```

**Step 2: Generate a log entry**

Run:
```bash
cd backend && php artisan tinker --execute="Log::info('Test log message', ['user_id' => 123]);"
```

**Step 3: View log format**

Run:
```bash
cat backend/storage/logs/laravel-*.log
```

Expected: Standard text format log entry

---

## Task 5: Test JSON Logging

**Files:** None

**Step 1: Set LOG_FORMAT to json temporarily**

Run:
```bash
cd backend && LOG_FORMAT=json php artisan tinker --execute="Log::info('Test JSON log', ['user_id' => 456]);"
```

**Step 2: View JSON log format**

Run:
```bash
tail -1 backend/storage/logs/laravel-*.log
```

Expected: JSON formatted log entry like:
```json
{"message":"Test JSON log","context":{"user_id":456},"level":200,"level_name":"INFO",...}
```

---

## Task 6: Verify stderr Channel (Production-like)

**Files:** None

**Step 1: Test stderr channel with JSON**

Run:
```bash
cd backend && LOG_CHANNEL=stderr php artisan tinker --execute="Log::error('Stderr test', ['code' => 500]);" 2>&1
```

Expected: JSON output to stderr

---

## Task 7: Commit Logging Configuration

**Files:**
- `backend/config/logging.php`
- `backend/.env.example`

**Step 1: Check git status**

Run:
```bash
git status
```

**Step 2: Stage logging files**

Run:
```bash
git add backend/config/logging.php backend/.env.example
```

**Step 3: Create commit**

Run:
```bash
git commit -m "$(cat <<'EOF'
feat: add structured JSON logging support

- JSON formatter for production (LOG_FORMAT=json)
- Standard format for local development
- stderr channel with JSON for containerized deployments
- 14-day log retention
EOF
)"
```

**Step 4: Verify commit**

Run:
```bash
git log --oneline -1
```

Expected: Commit message "feat: add structured JSON logging support"

---

## Phase 0.7 Completion Checklist

- [ ] logging.php reviewed
- [ ] JSON formatter added for daily channel
- [ ] LOG_FORMAT environment variable support
- [ ] stderr channel configured with JSON
- [ ] 14-day log retention configured
- [ ] Standard logging tested
- [ ] JSON logging tested
- [ ] stderr channel tested
- [ ] .env.example updated
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 0.8: Gitignore Finalization** for final cleanup and Phase 0 completion.
