# Phase 0.4: Sentry Error Monitoring

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Integrate Sentry for error tracking and performance monitoring.

**Architecture:** Sentry Laravel SDK with filtered exception reporting and performance sampling.

**Tech Stack:** Sentry Laravel SDK, Sentry Free Tier

**Prerequisites:**
- Phase 0.3 completed (CI/CD pipeline)
- Sentry account created at https://sentry.io
- Sentry Laravel project created and DSN obtained

**Reference:** `docs/specifications/03-backend-architecture.md`

---

## Task 1: Install Sentry Laravel SDK

**Files:**
- Modify: `backend/composer.json`

**Step 1: Install Sentry SDK**

Run:
```bash
cd backend && composer require sentry/sentry-laravel
```

Expected: Package installed successfully

**Step 2: Verify installation**

Run:
```bash
cd backend && composer show sentry/sentry-laravel
```

Expected: Package information displayed

---

## Task 2: Publish Sentry Configuration

**Files:**
- Create: `backend/config/sentry.php`

**Step 1: Publish Sentry config**

Run:
```bash
cd backend && php artisan sentry:publish
```

Expected: Config file published to `config/sentry.php`

**Step 2: Verify config file created**

Run:
```bash
ls -la backend/config/sentry.php
```

Expected: File exists

---

## Task 3: Configure Sentry Settings

**Files:**
- Modify: `backend/config/sentry.php`

**Step 1: Read current sentry config**

Read `backend/config/sentry.php` to see default configuration.

**Step 2: Update sentry.php with custom configuration**

Replace contents of `backend/config/sentry.php`:
```php
<?php

return [
    'dsn' => env('SENTRY_LARAVEL_DSN'),

    'release' => env('APP_VERSION', '1.0.0'),

    'environment' => env('APP_ENV', 'production'),

    // Don't send PII by default
    'send_default_pii' => false,

    // Sample rate for performance monitoring
    'traces_sample_rate' => env('APP_ENV') === 'production' ? 0.1 : 1.0,

    // Breadcrumbs
    'breadcrumbs' => [
        'logs' => true,
        'sql_queries' => true,
        'sql_bindings' => false,
        'queue_info' => true,
        'command_info' => true,
    ],
];
```

---

## Task 4: Configure Exception Filtering

**Files:**
- Modify: `backend/app/Exceptions/Handler.php`

**Step 1: Read current Handler.php**

Read `backend/app/Exceptions/Handler.php` to see current implementation.

**Step 2: Update Handler.php with Sentry integration**

Replace contents of `backend/app/Exceptions/Handler.php`:
```php
<?php

namespace App\Exceptions;

use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
use Illuminate\Validation\ValidationException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
use Throwable;

class Handler extends ExceptionHandler
{
    protected $dontReport = [
        //
    ];

    protected $dontFlash = [
        'current_password',
        'password',
        'password_confirmation',
    ];

    public function register(): void
    {
        $this->reportable(function (Throwable $e) {
            // Don't report validation errors to Sentry
            if ($e instanceof ValidationException) {
                return false;
            }

            // Don't report 404 errors
            if ($e instanceof NotFoundHttpException) {
                return false;
            }

            // Report to Sentry
            if (app()->bound('sentry')) {
                app('sentry')->captureException($e);
            }
        });
    }
}
```

---

## Task 5: Add Sentry DSN to Environment

**Files:**
- Modify: `backend/.env`
- Verify: `backend/.env.example`

**Step 1: Add DSN to local .env**

Add to `backend/.env` (replace with your actual DSN):
```env
SENTRY_LARAVEL_DSN=https://xxx@xxx.ingest.sentry.io/xxx
```

Note: Get DSN from Sentry project settings.

**Step 2: Verify .env.example has placeholder**

Ensure `backend/.env.example` has:
```env
SENTRY_LARAVEL_DSN=
```

---

## Task 6: Test Sentry Integration

**Files:**
- Temporary modification to: `backend/routes/web.php`

**Step 1: Add test route**

Add temporarily to `backend/routes/web.php`:
```php
Route::get('/debug-sentry', function () {
    throw new \Exception('Sentry test exception!');
});
```

**Step 2: Start server**

Run:
```bash
cd backend && php artisan serve &
```

**Step 3: Trigger test exception**

Run:
```bash
curl http://localhost:8000/debug-sentry
```

Expected: 500 error response

**Step 4: Check Sentry dashboard**

Open Sentry dashboard and verify "Sentry test exception!" appears.

**Step 5: Stop server**

Run:
```bash
pkill -f "php artisan serve"
```

**Step 6: Remove test route**

Remove the `/debug-sentry` route from `backend/routes/web.php`.

---

## Task 7: Commit Sentry Setup

**Files:**
- `backend/composer.json`
- `backend/composer.lock`
- `backend/config/sentry.php`
- `backend/app/Exceptions/Handler.php`

**Step 1: Check git status**

Run:
```bash
git status
```

**Step 2: Stage Sentry files**

Run:
```bash
git add backend/composer.json backend/composer.lock backend/config/sentry.php backend/app/Exceptions/Handler.php
```

**Step 3: Create commit**

Run:
```bash
git commit -m "$(cat <<'EOF'
feat: add Sentry error monitoring

- Sentry Laravel SDK installed
- Custom config with performance sampling
- Exception filtering (exclude 404, validation)
- PII protection enabled
EOF
)"
```

**Step 4: Verify commit**

Run:
```bash
git log --oneline -1
```

Expected: Commit message "feat: add Sentry error monitoring"

---

## Phase 0.4 Completion Checklist

- [ ] Sentry Laravel SDK installed
- [ ] sentry.php config published and customized
- [ ] Performance sampling configured (10% prod, 100% local)
- [ ] PII sending disabled
- [ ] Breadcrumbs enabled for logs, SQL, queue
- [ ] Exception Handler updated
- [ ] Validation errors filtered from Sentry
- [ ] 404 errors filtered from Sentry
- [ ] DSN added to .env
- [ ] Sentry integration tested
- [ ] Test route removed
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 0.5: Health Check Endpoint** for system health monitoring.
