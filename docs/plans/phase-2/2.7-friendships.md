# Phase 2.7: Friendships

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create complete friendship system with requests, acceptance, and removal.

**Architecture:** FriendshipController → FriendshipService → Friendship model. Requires email verification.

**Tech Stack:** Laravel Service Layer, Middleware

**Prerequisites:** Phase 2.6 complete

**Reference:** `docs/specifications/05-api-endpoints.md`, `docs/plans/phase-2-auth-and-users.md` Task 7

---

## Implementation

Follow **Task 7** from `docs/plans/phase-2-auth-and-users.md`:

1. **Write friendship tests** - `tests/Feature/Friendship/FriendshipTest.php`
   - Test send friend request
   - Test accept friend request
   - Test list friends
   - Test unverified user cannot send request (EMAIL_NOT_VERIFIED)

2. **Create EnsureEmailVerified middleware** - `app/Http/Middleware/EnsureEmailVerified.php`
   - Check `email_verified_at` is not null
   - Throw ApiException EMAIL_NOT_VERIFIED if null

3. **Register middleware alias** in `bootstrap/app.php`:
   ```php
   ->withMiddleware(function (Middleware $middleware) {
       $middleware->alias([
           'verified' => \App\Http\Middleware\EnsureEmailVerified::class,
       ]);
   })
   ```

4. **Create FriendshipService** - `app/Services/FriendshipService.php`
   - getFriends(): Get accepted friendships
   - getPendingRequests(): Get pending received requests
   - sendRequest(): Create pending friendship
   - accept(): Update status to accepted
   - decline(): Delete friendship
   - remove(): Delete friendship

5. **Create FriendshipResource** - `app/Http/Resources/FriendshipResource.php`

6. **Create FriendshipController** - `app/Http/Controllers/Api/V1/FriendshipController.php`

7. **Add routes** (inside auth:sanctum + verified):
   ```php
   Route::middleware('verified')->group(function () {
       Route::get('friends', [FriendshipController::class, 'index']);
       Route::get('friends/requests', [FriendshipController::class, 'requests']);
       Route::post('friends', [FriendshipController::class, 'store']);
       Route::put('friends/{friendship}/accept', [FriendshipController::class, 'accept']);
       Route::put('friends/{friendship}/decline', [FriendshipController::class, 'decline']);
       Route::delete('friends/{friendship}', [FriendshipController::class, 'destroy']);
   });
   ```

8. **Run tests and commit**

---

## Key Validation Rules

- Cannot send request to yourself
- Cannot send request if friendship exists
- Only addressee can accept/decline
- Only participants can remove

---

## Phase 2.7 Completion Checklist

- [ ] EnsureEmailVerified middleware created
- [ ] Middleware registered as 'verified'
- [ ] FriendshipService with all methods
- [ ] FriendshipResource created
- [ ] FriendshipController with CRUD
- [ ] Routes with 'verified' middleware
- [ ] Tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 2.8: Email Verification** for verification emails.
