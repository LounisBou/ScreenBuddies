# Phase 2.1: API Error Handling

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create consistent API error response structure.

**Architecture:** Custom ApiException + global exception rendering in bootstrap/app.php.

**Tech Stack:** Laravel 11 Exceptions

**Prerequisites:** Phase 1 complete

**Reference:** `docs/specifications/05-api-endpoints.md`

---

## Task 1: Create ApiException Class

**Files:**
- Create: `backend/app/Exceptions/ApiException.php`

**Step 1: Create ApiException**

Create `backend/app/Exceptions/ApiException.php`:
```php
<?php

namespace App\Exceptions;

use Exception;
use Illuminate\Http\JsonResponse;

class ApiException extends Exception
{
    public function __construct(
        public string $errorCode,
        string $message,
        public int $httpStatus = 400,
        public array $details = []
    ) {
        parent::__construct($message);
    }

    public function render(): JsonResponse
    {
        return response()->json([
            'error' => [
                'code' => $this->errorCode,
                'message' => $this->getMessage(),
                'details' => $this->details ?: null,
            ],
        ], $this->httpStatus);
    }
}
```

---

## Task 2: Configure Global Exception Handling

**Files:**
- Modify: `backend/bootstrap/app.php`

**Step 1: Read current bootstrap/app.php**

Read `backend/bootstrap/app.php`.

**Step 2: Add exception renderers**

Add to the `withExceptions` callback:
```php
use Illuminate\Validation\ValidationException;
use Illuminate\Auth\AuthenticationException;

->withExceptions(function (Exceptions $exceptions) {
    $exceptions->render(function (ValidationException $e) {
        return response()->json([
            'error' => [
                'code' => 'VALIDATION_ERROR',
                'message' => 'The given data was invalid.',
                'details' => $e->errors(),
            ],
        ], 422);
    });

    $exceptions->render(function (AuthenticationException $e) {
        return response()->json([
            'error' => [
                'code' => 'UNAUTHORIZED',
                'message' => 'Unauthenticated.',
            ],
        ], 401);
    });
})
```

---

## Task 3: Write Error Handling Test

**Files:**
- Create: `backend/tests/Feature/Api/ErrorHandlingTest.php`

**Step 1: Create test file**

Create `backend/tests/Feature/Api/ErrorHandlingTest.php`:
```php
<?php

test('validation errors return correct format', function () {
    $response = $this->postJson('/api/v1/auth/register', [
        'email' => 'invalid',
    ]);

    $response->assertStatus(422)
        ->assertJsonStructure([
            'error' => ['code', 'message', 'details'],
        ])
        ->assertJsonPath('error.code', 'VALIDATION_ERROR');
});

test('unauthenticated requests return correct format', function () {
    $response = $this->getJson('/api/v1/me');

    $response->assertStatus(401)
        ->assertJsonPath('error.code', 'UNAUTHORIZED');
});
```

Note: These tests will pass after register endpoint is created in 2.2.

---

## Task 4: Commit

**Step 1: Stage and commit**

Run:
```bash
git add backend/ && git commit -m "feat: add API exception handling"
```

---

## Phase 2.1 Completion Checklist

- [ ] ApiException class created
- [ ] ValidationException renders as JSON
- [ ] AuthenticationException renders as JSON
- [ ] Consistent error format: {error: {code, message, details}}
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 2.2: Registration** for user registration endpoint.
