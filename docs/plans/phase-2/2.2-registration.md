# Phase 2.2: User Registration

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create user registration endpoint with Sanctum tokens.

**Architecture:** RegisterRequest → AuthController → User + UserPreference + Tokens.

**Tech Stack:** Laravel Sanctum, Form Requests, API Resources

**Prerequisites:** Phase 2.1 complete

**Reference:** `docs/specifications/05-api-endpoints.md`

---

## Task 1: Write Registration Tests (TDD)

**Files:**
- Create: `backend/tests/Feature/Auth/RegisterTest.php`

**Step 1: Create test file**

Create `backend/tests/Feature/Auth/RegisterTest.php`:
```php
<?php

use App\Models\User;

test('user can register with valid data', function () {
    $response = $this->postJson('/api/v1/auth/register', [
        'email' => 'test@example.com',
        'password' => 'password123',
        'password_confirmation' => 'password123',
        'display_name' => 'Test User',
        'locale' => 'en',
    ]);

    $response->assertStatus(201)
        ->assertJsonStructure([
            'data' => [
                'user' => ['id', 'email', 'display_name', 'locale'],
                'tokens' => ['access_token', 'refresh_token', 'expires_in'],
            ],
        ]);

    $this->assertDatabaseHas('users', ['email' => 'test@example.com']);
});

test('register fails with invalid email', function () {
    $response = $this->postJson('/api/v1/auth/register', [
        'email' => 'invalid-email',
        'password' => 'password123',
        'password_confirmation' => 'password123',
    ]);

    $response->assertStatus(422)
        ->assertJsonPath('error.code', 'VALIDATION_ERROR');
});

test('register fails with duplicate email', function () {
    User::factory()->create(['email' => 'existing@example.com']);

    $response = $this->postJson('/api/v1/auth/register', [
        'email' => 'existing@example.com',
        'password' => 'password123',
        'password_confirmation' => 'password123',
    ]);

    $response->assertStatus(422);
});

test('register fails with weak password', function () {
    $response = $this->postJson('/api/v1/auth/register', [
        'email' => 'test@example.com',
        'password' => 'short',
        'password_confirmation' => 'short',
    ]);

    $response->assertStatus(422);
});
```

**Step 2: Run tests to verify they fail**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Feature/Auth/RegisterTest.php
```

Expected: FAIL (route not defined)

---

## Task 2: Create RegisterRequest

**Files:**
- Create: `backend/app/Http/Requests/Auth/RegisterRequest.php`

**Step 1: Create directory**

Run:
```bash
mkdir -p /Users/lounis/dev/ScreenBuddies/backend/app/Http/Requests/Auth
```

**Step 2: Create RegisterRequest**

Create `backend/app/Http/Requests/Auth/RegisterRequest.php`:
```php
<?php

namespace App\Http\Requests\Auth;

use Illuminate\Foundation\Http\FormRequest;

class RegisterRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'email' => ['required', 'email', 'unique:users,email', 'max:255'],
            'password' => ['required', 'string', 'min:8', 'confirmed'],
            'display_name' => ['nullable', 'string', 'max:100'],
            'locale' => ['nullable', 'string', 'in:en,fr'],
        ];
    }
}
```

---

## Task 3: Create API Resources

**Files:**
- Create: `backend/app/Http/Resources/UserResource.php`
- Create: `backend/app/Http/Resources/AuthResource.php`

**Step 1: Create UserResource**

Create `backend/app/Http/Resources/UserResource.php`:
```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class UserResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'email' => $this->email,
            'display_name' => $this->display_name,
            'avatar_url' => $this->avatar_url,
            'email_verified' => $this->email_verified_at !== null,
            'locale' => $this->preference?->locale ?? 'en',
            'notif_email' => $this->preference?->notif_email ?? true,
            'notif_push' => $this->preference?->notif_push ?? true,
            'created_at' => $this->created_at->toIso8601String(),
        ];
    }
}
```

**Step 2: Create AuthResource**

Create `backend/app/Http/Resources/AuthResource.php`:
```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class AuthResource extends JsonResource
{
    public function __construct(
        public $user,
        public string $accessToken,
        public string $refreshToken,
        public int $expiresIn
    ) {
        parent::__construct($user);
    }

    public function toArray(Request $request): array
    {
        return [
            'user' => new UserResource($this->user),
            'tokens' => [
                'access_token' => $this->accessToken,
                'refresh_token' => $this->refreshToken,
                'expires_in' => $this->expiresIn,
            ],
        ];
    }
}
```

---

## Task 4: Create AuthController

**Files:**
- Create: `backend/app/Http/Controllers/Api/V1/AuthController.php`

**Step 1: Create directory**

Run:
```bash
mkdir -p /Users/lounis/dev/ScreenBuddies/backend/app/Http/Controllers/Api/V1
```

**Step 2: Create AuthController**

Create `backend/app/Http/Controllers/Api/V1/AuthController.php`:
```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\Auth\RegisterRequest;
use App\Http\Resources\AuthResource;
use App\Models\User;
use Illuminate\Http\JsonResponse;

class AuthController extends Controller
{
    public function register(RegisterRequest $request): JsonResponse
    {
        $user = User::create([
            'email' => $request->email,
            'password' => $request->password,
            'display_name' => $request->display_name,
        ]);

        // Create user preferences
        $user->preference()->create([
            'locale' => $request->locale ?? 'en',
        ]);

        $user->load('preference');

        // Create Sanctum tokens
        $accessToken = $user->createToken('access', ['access'], now()->addMinutes(config('sanctum.expiration')))->plainTextToken;
        $refreshToken = $user->createToken('refresh', ['refresh'], now()->addMinutes(config('sanctum.refresh_expiration')))->plainTextToken;

        return response()->json([
            'data' => new AuthResource(
                $user,
                $accessToken,
                $refreshToken,
                config('sanctum.expiration') * 60
            ),
        ], 201);
    }
}
```

---

## Task 5: Update User Factory

**Files:**
- Modify: `backend/database/factories/UserFactory.php`

**Step 1: Read current factory**

Read `backend/database/factories/UserFactory.php`.

**Step 2: Update factory with afterCreating**

Ensure factory creates UserPreference and has states:
```php
<?php

namespace Database\Factories;

use App\Models\User;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

class UserFactory extends Factory
{
    public function definition(): array
    {
        return [
            'email' => fake()->unique()->safeEmail(),
            'password' => Hash::make('password'),
            'display_name' => fake()->name(),
            'avatar_url' => null,
            'email_verified_at' => now(),
            'is_admin' => false,
            'is_banned' => false,
            'remember_token' => Str::random(10),
        ];
    }

    public function configure(): static
    {
        return $this->afterCreating(function (User $user) {
            $user->preference()->create([
                'locale' => 'en',
                'notif_email' => true,
                'notif_push' => true,
            ]);
        });
    }

    public function unverified(): static
    {
        return $this->state(fn (array $attributes) => [
            'email_verified_at' => null,
        ]);
    }

    public function admin(): static
    {
        return $this->state(fn (array $attributes) => [
            'is_admin' => true,
        ]);
    }
}
```

---

## Task 6: Add Routes

**Files:**
- Modify: `backend/routes/api.php`

**Step 1: Update api.php**

Update `backend/routes/api.php`:
```php
<?php

use App\Http\Controllers\Api\HealthController;
use App\Http\Controllers\Api\V1\AuthController;
use Illuminate\Support\Facades\Route;

// Health check (no auth required)
Route::get('health', HealthController::class);

Route::prefix('v1')->group(function () {
    // Auth routes (public)
    Route::prefix('auth')->group(function () {
        Route::post('register', [AuthController::class, 'register']);
    });
});
```

---

## Task 7: Run Tests

**Files:** None

**Step 1: Run registration tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Feature/Auth/RegisterTest.php
```

Expected: All tests PASS

---

## Task 8: Commit

**Step 1: Stage and commit**

Run:
```bash
git add backend/ && git commit -m "feat: add user registration endpoint"
```

---

## Phase 2.2 Completion Checklist

- [ ] RegisterRequest with validation rules
- [ ] UserResource for user JSON format
- [ ] AuthResource for auth response format
- [ ] AuthController::register method
- [ ] User factory with afterCreating hook
- [ ] POST /api/v1/auth/register route
- [ ] All tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 2.3: Login** for user login endpoint.
