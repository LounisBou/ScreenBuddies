# Phase 2.4: Token Management

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create token refresh and logout endpoints.

**Architecture:** Refresh validates refresh token and issues new pair. Logout deletes current token.

**Tech Stack:** Laravel Sanctum PersonalAccessToken

**Prerequisites:** Phase 2.3 complete

**Reference:** `docs/specifications/05-api-endpoints.md`, `docs/plans/phase-2-auth-and-users.md` Task 4

---

## Implementation

Follow **Task 4** from `docs/plans/phase-2-auth-and-users.md`:

1. **Write token tests** - `tests/Feature/Auth/TokenTest.php`
   - Test refresh with valid token
   - Test logout
   - Test logout without token (401)

2. **Add refresh method to AuthController**
   - Find token via `PersonalAccessToken::findToken()`
   - Verify it has 'refresh' ability
   - Check expiration
   - Delete old token, create new pair

3. **Add logout method to AuthController**
   - Delete `currentAccessToken()`
   - Return 204 No Content

4. **Update routes**:
   ```php
   Route::post('refresh', [AuthController::class, 'refresh']);

   Route::middleware('auth:sanctum')->group(function () {
       Route::post('auth/logout', [AuthController::class, 'logout']);
   });
   ```

5. **Run tests and commit**

---

## Key Code

```php
// AuthController::refresh
public function refresh(Request $request): JsonResponse
{
    $token = PersonalAccessToken::findToken($request->refresh_token);

    if (!$token || !in_array('refresh', $token->abilities)) {
        throw new ApiException('INVALID_TOKEN', 'Invalid refresh token.', 401);
    }

    if ($token->expires_at?->isPast()) {
        $token->delete();
        throw new ApiException('INVALID_TOKEN', 'Refresh token has expired.', 401);
    }

    $user = $token->tokenable;
    $token->delete();

    // Create new tokens and return
}

// AuthController::logout
public function logout(): JsonResponse
{
    auth()->user()->currentAccessToken()->delete();
    return response()->json(null, 204);
}
```

---

## Phase 2.4 Completion Checklist

- [ ] refresh() method validates refresh token
- [ ] refresh() checks token abilities
- [ ] refresh() checks expiration
- [ ] refresh() deletes old token and creates new pair
- [ ] logout() deletes current access token
- [ ] Routes added (refresh public, logout protected)
- [ ] Tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 2.5: User Profile** for profile endpoints.
