# Phase 2.8: Email Verification

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create email verification system with signed URLs.

**Architecture:** Notification sends signed URL, controller verifies signature and updates user.

**Tech Stack:** Laravel Notifications, Signed Routes

**Prerequisites:** Phase 2.7 complete

**Reference:** `docs/specifications/05-api-endpoints.md`, `docs/plans/phase-2-auth-and-users.md` Task 8

---

## Implementation

Follow **Task 8** from `docs/plans/phase-2-auth-and-users.md`:

1. **Write verification tests** - `tests/Feature/Auth/EmailVerificationTest.php`
   - Test verify email with valid signed URL
   - Test resend verification email

2. **Create VerifyEmailNotification** - `app/Notifications/VerifyEmailNotification.php`
   - Implements ShouldQueue
   - Generates signed URL with 60 min expiration

3. **Add verification methods to AuthController**
   - verifyEmail(): Validate hash, update email_verified_at
   - resendVerification(): Send notification

4. **Update register** to send verification email

5. **Add routes**:
   ```php
   // Public, signed
   Route::get('auth/verify-email/{id}/{hash}', [AuthController::class, 'verifyEmail'])
       ->name('verification.verify')
       ->middleware('signed');

   // Protected
   Route::post('auth/resend-verification', [AuthController::class, 'resendVerification']);
   ```

6. **Run tests and commit**

---

## Key Code

```php
// VerifyEmailNotification
protected function verificationUrl($notifiable): string
{
    return URL::temporarySignedRoute(
        'verification.verify',
        now()->addMinutes(60),
        ['id' => $notifiable->id, 'hash' => sha1($notifiable->email)]
    );
}

// AuthController::verifyEmail
public function verifyEmail(Request $request, int $id, string $hash): JsonResponse
{
    $user = User::findOrFail($id);

    if (!hash_equals($hash, sha1($user->email))) {
        throw new ApiException('INVALID_VERIFICATION', 'Invalid verification link.', 400);
    }

    $user->update(['email_verified_at' => now()]);

    return response()->json([
        'data' => ['message' => 'Email verified successfully.'],
    ]);
}
```

---

## Phase 2.8 Completion Checklist

- [ ] VerifyEmailNotification created
- [ ] Notification queued (ShouldQueue)
- [ ] Signed URL with 60 min expiration
- [ ] verifyEmail() validates hash
- [ ] resendVerification() sends notification
- [ ] Register sends verification email
- [ ] Routes added
- [ ] Tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 2.9: Finalization** for final verification.
