# Phase 3.3: TMDB Provider

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create TMDB provider for movie and TV show search with caching and circuit breaker.

**Architecture:** Provider implements MediaProviderInterface, uses GaneshaService for HTTP, caches results.

**Tech Stack:** Guzzle, Laravel Cache, Ganesha

**Prerequisites:** Phase 3.2 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 3

---

## Task 1: Write TMDB Provider Tests

**Step 1: Create test file**

Create `backend/tests/Unit/Services/Media/TmdbProviderTest.php`:
```php
<?php

use App\Services\Media\Providers\TmdbProvider;
use App\Services\Media\DTOs\PaginatedResults;
use Illuminate\Support\Facades\Http;

test('tmdb provider returns movie type', function () {
    $provider = new TmdbProvider('movie');

    expect($provider->getType())->toBe('movie');
});

test('tmdb provider returns tvshow type', function () {
    $provider = new TmdbProvider('tvshow');

    expect($provider->getType())->toBe('tvshow');
});

test('tmdb provider can search movies', function () {
    Http::fake([
        'api.themoviedb.org/*' => Http::response([
            'page' => 1,
            'total_pages' => 1,
            'total_results' => 1,
            'results' => [
                [
                    'id' => 603,
                    'title' => 'The Matrix',
                    'poster_path' => '/poster.jpg',
                    'release_date' => '1999-03-30',
                    'overview' => 'A computer hacker learns...',
                    'vote_average' => 8.7,
                    'genre_ids' => [28, 878],
                ],
            ],
        ]),
    ]);

    $provider = new TmdbProvider('movie');
    $results = $provider->search('matrix');

    expect($results)->toBeInstanceOf(PaginatedResults::class);
    expect($results->items)->toHaveCount(1);
    expect($results->items[0]->title)->toBe('The Matrix');
    expect($results->items[0]->externalId)->toBe('tmdb:603');
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Unit/Services/Media/TmdbProviderTest.php
```
Expected: FAIL (class not found)

**Step 3: Commit test**

```bash
git add backend/tests/Unit/Services/Media/TmdbProviderTest.php
git commit -m "test: add TMDB provider tests"
```

---

## Task 2: Implement TmdbProvider

**Step 1: Create TmdbProvider class**

Create `backend/app/Services/Media/Providers/TmdbProvider.php`:
```php
<?php

namespace App\Services\Media\Providers;

use App\Exceptions\ApiException;
use App\Services\CircuitBreaker\GaneshaService;
use App\Services\Media\Contracts\MediaProviderInterface;
use App\Services\Media\DTOs\MediaItem;
use App\Services\Media\DTOs\PaginatedResults;
use GuzzleHttp\Exception\RequestException;
use Illuminate\Support\Facades\Cache;

class TmdbProvider implements MediaProviderInterface
{
    private string $baseUrl;
    private string $apiKey;
    private string $imageBaseUrl;
    private GaneshaService $ganeshaService;

    public function __construct(
        private string $type = 'movie'
    ) {
        $this->baseUrl = config('media.tmdb.base_url');
        $this->apiKey = config('media.tmdb.api_key');
        $this->imageBaseUrl = config('media.tmdb.image_base_url');
        $this->ganeshaService = app(GaneshaService::class);
    }

    public function getType(): string
    {
        return $this->type;
    }

    public function search(string $query, int $page = 1): PaginatedResults
    {
        $cacheKey = "media:tmdb:{$this->type}:search:" . md5($query) . ":$page";

        return Cache::remember($cacheKey, config('media.cache_ttl.search'), function () use ($query, $page) {
            $endpoint = $this->type === 'movie' ? '/search/movie' : '/search/tv';

            try {
                $client = $this->ganeshaService->getHttpClient('tmdb');
                $response = $client->get($this->baseUrl . $endpoint, [
                    'query' => [
                        'api_key' => $this->apiKey,
                        'query' => $query,
                        'page' => $page,
                    ],
                ]);

                $data = json_decode($response->getBody()->getContents(), true);
            } catch (RequestException $e) {
                // Circuit is open or request failed - return empty results
                throw new ApiException(
                    'SERVICE_UNAVAILABLE',
                    'TMDB service is temporarily unavailable.',
                    503
                );
            }

            $items = array_map(
                fn ($item) => $this->mapToMediaItem($item),
                $data['results'] ?? []
            );

            return new PaginatedResults(
                items: $items,
                currentPage: $data['page'] ?? 1,
                totalPages: $data['total_pages'] ?? 1,
                totalResults: $data['total_results'] ?? 0
            );
        });
    }

    public function getById(string $externalId): ?MediaItem
    {
        $id = str_replace('tmdb:', '', $externalId);
        $cacheKey = "media:tmdb:{$this->type}:item:$id";

        return Cache::remember($cacheKey, config('media.cache_ttl.details'), function () use ($id) {
            $endpoint = $this->type === 'movie' ? "/movie/$id" : "/tv/$id";

            try {
                $client = $this->ganeshaService->getHttpClient('tmdb');
                $response = $client->get($this->baseUrl . $endpoint, [
                    'query' => ['api_key' => $this->apiKey],
                ]);

                $data = json_decode($response->getBody()->getContents(), true);
                return $this->mapToMediaItem($data);
            } catch (RequestException $e) {
                return null;
            }
        });
    }

    private function mapToMediaItem(array $data): MediaItem
    {
        $isMovie = $this->type === 'movie';

        return new MediaItem(
            externalId: 'tmdb:' . $data['id'],
            title: $data[$isMovie ? 'title' : 'name'] ?? 'Unknown',
            posterUrl: isset($data['poster_path'])
                ? $this->imageBaseUrl . $data['poster_path']
                : null,
            year: $this->extractYear($data[$isMovie ? 'release_date' : 'first_air_date'] ?? null),
            metadata: [
                'overview' => $data['overview'] ?? null,
                'rating' => $data['vote_average'] ?? null,
                'genre_ids' => $data['genre_ids'] ?? [],
            ]
        );
    }

    private function extractYear(?string $date): ?int
    {
        if (!$date) {
            return null;
        }

        $parts = explode('-', $date);
        return isset($parts[0]) ? (int) $parts[0] : null;
    }
}
```

**Step 2: Run tests**

```bash
php artisan test tests/Unit/Services/Media/TmdbProviderTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/app/Services/Media/Providers/TmdbProvider.php
git commit -m "feat: add TMDB media provider"
```

---

## Phase 3.3 Completion Checklist

- [ ] TmdbProvider tests written (TDD)
- [ ] TmdbProvider implements MediaProviderInterface
- [ ] search() with caching (1 hour TTL)
- [ ] getById() with caching (24 hour TTL)
- [ ] Circuit breaker integration via GaneshaService
- [ ] Handles both 'movie' and 'tvshow' types
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 3.4: RAWG Provider** for video game search.
