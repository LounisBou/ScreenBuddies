# Phase 3.9: Join Election System

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create invite link and join flow for elections using invite_token.

**Architecture:** Maestro gets invite link, users preview via token, authenticated users join.

**Tech Stack:** Laravel Routes, Token-based access

**Prerequisites:** Phase 3.8 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 9

---

## Task 1: Write Join Election Tests

**Step 1: Create test file**

Create `backend/tests/Feature/Election/JoinElectionTest.php`:
```php
<?php

use App\Models\User;
use App\Models\Election;
use App\Models\MediaType;
use Laravel\Sanctum\Sanctum;

beforeEach(function () {
    MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('maestro can get invite link', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $election = Election::factory()->create(['maestro_id' => $user->id]);
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}/invite-link");

    $response->assertStatus(200)
        ->assertJsonStructure(['data' => ['invite_link', 'invite_token']]);
});

test('non-maestro cannot get invite link', function () {
    $maestro = User::factory()->create();
    $otherUser = User::factory()->create();
    $election = Election::factory()->create(['maestro_id' => $maestro->id]);
    $token = $otherUser->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}/invite-link");

    $response->assertStatus(403);
});

test('anyone can preview election via invite token', function () {
    $election = Election::factory()->create();

    $response = $this->getJson("/api/v1/elections/join/{$election->invite_token}");

    $response->assertStatus(200)
        ->assertJsonPath('data.election.uuid', $election->uuid)
        ->assertJsonPath('data.requires_auth', true);
});

test('invalid invite token returns 404', function () {
    $response = $this->getJson('/api/v1/elections/join/invalid-token');

    $response->assertStatus(404);
});

test('authenticated user can join election via invite token', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->postJson("/api/v1/elections/join/{$election->invite_token}");

    $response->assertStatus(200)
        ->assertJsonPath('data.already_joined', false);

    $this->assertDatabaseHas('voters', [
        'election_id' => $election->id,
        'user_id' => $user->id,
    ]);
});

test('user cannot join same election twice', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    // Join first time
    $this->withHeader('Authorization', "Bearer $token")
        ->postJson("/api/v1/elections/join/{$election->invite_token}");

    // Try to join again
    $response = $this->withHeader('Authorization', "Bearer $token")
        ->postJson("/api/v1/elections/join/{$election->invite_token}");

    $response->assertStatus(200)
        ->assertJsonPath('data.already_joined', true);

    $this->assertDatabaseCount('voters', 1);
});

test('unauthenticated user cannot join election', function () {
    $election = Election::factory()->create();

    $response = $this->postJson("/api/v1/elections/join/{$election->invite_token}");

    $response->assertStatus(401);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Feature/Election/JoinElectionTest.php
```
Expected: FAIL (routes not found)

**Step 3: Commit test**

```bash
git add backend/tests/Feature/Election/JoinElectionTest.php
git commit -m "test: add join election tests"
```

---

## Task 2: Add Join Methods to ElectionController

**Step 1: Add join methods**

Add to `backend/app/Http/Controllers/Api/V1/ElectionController.php`:

```php
use App\Models\Voter;
use Illuminate\Http\Request;

// Add these methods to the class:

public function getInviteLink(string $uuid): JsonResponse
{
    $election = Election::where('uuid', $uuid)->firstOrFail();

    if ($election->maestro_id !== auth()->id()) {
        throw new ApiException(
            'FORBIDDEN',
            'Only the maestro can get the invite link.',
            403
        );
    }

    $inviteLink = config('app.frontend_url', config('app.url')) . '/join/' . $election->invite_token;

    return response()->json([
        'data' => [
            'invite_link' => $inviteLink,
            'invite_token' => $election->invite_token,
        ],
    ]);
}

public function showByInviteToken(string $inviteToken): JsonResponse
{
    $election = Election::where('invite_token', $inviteToken)
        ->with(['mediaType', 'maestro'])
        ->first();

    if (!$election) {
        throw new ApiException(
            'NOT_FOUND',
            'Election not found.',
            404
        );
    }

    return response()->json([
        'data' => [
            'election' => [
                'uuid' => $election->uuid,
                'title' => $election->title,
                'media_type' => [
                    'code' => $election->mediaType->code,
                    'label' => __($election->mediaType->label),
                ],
                'maestro' => [
                    'display_name' => $election->maestro->display_name,
                ],
                'status' => $election->status->value,
                'candidate_count' => $election->candidates()->count(),
                'voter_count' => $election->voters()->count(),
            ],
            'requires_auth' => true,
        ],
    ]);
}

public function joinByInviteToken(Request $request, string $inviteToken): JsonResponse
{
    $election = Election::where('invite_token', $inviteToken)
        ->with(['mediaType', 'maestro', 'candidates', 'voters.user'])
        ->first();

    if (!$election) {
        throw new ApiException(
            'NOT_FOUND',
            'Election not found.',
            404
        );
    }

    $user = auth()->user();

    $existingVoter = Voter::where('election_id', $election->id)
        ->where('user_id', $user->id)
        ->first();

    if (!$existingVoter) {
        Voter::create([
            'election_id' => $election->id,
            'user_id' => $user->id,
            'joined_at' => now(),
        ]);

        $election->load('voters.user'); // Refresh voters
    }

    return response()->json([
        'data' => [
            'election' => new ElectionDetailResource($election),
            'already_joined' => (bool) $existingVoter,
        ],
    ]);
}
```

**Step 2: Commit**

```bash
git add backend/app/Http/Controllers/Api/V1/ElectionController.php
git commit -m "feat: add join election methods to controller"
```

---

## Task 3: Add Join Routes

**Step 1: Add routes**

Update `backend/routes/api.php`:

```php
// Public route (no auth required) - must be before auth middleware group
Route::get('elections/join/{inviteToken}', [ElectionController::class, 'showByInviteToken']);

// Inside auth:sanctum middleware:
Route::get('elections/{uuid}/invite-link', [ElectionController::class, 'getInviteLink']);
Route::post('elections/join/{inviteToken}', [ElectionController::class, 'joinByInviteToken']);
```

**Step 2: Run tests**

```bash
php artisan test tests/Feature/Election/JoinElectionTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/routes/api.php
git commit -m "feat: add join election routes"
```

---

## Phase 3.9 Completion Checklist

- [ ] Feature tests written (TDD)
- [ ] getInviteLink() returns link and token (maestro only)
- [ ] showByInviteToken() public preview
- [ ] joinByInviteToken() creates Voter record
- [ ] Idempotent join (already_joined flag)
- [ ] Routes added (public preview, auth for join)
- [ ] 404 for invalid tokens
- [ ] 403 for non-maestro invite link request
- [ ] All tests passing

---

## API Endpoints Created

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /api/v1/elections/{uuid}/invite-link | Get invite link | Maestro only |
| GET | /api/v1/elections/join/{token} | Preview election | Public |
| POST | /api/v1/elections/join/{token} | Join election | Required |

---

## Next Sub-Phase

Proceed to **Phase 3.10: Finalization** for full test suite.
