# Phase 3.6: Media Search Controller

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create API endpoints for media search and detail retrieval.

**Architecture:** Controller uses MediaSearchService, returns JSON with pagination meta.

**Tech Stack:** Laravel Controllers, Route middleware

**Prerequisites:** Phase 3.5 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 6

---

## Task 1: Write Media Search Feature Tests

**Step 1: Create test file**

Create `backend/tests/Feature/Media/MediaSearchTest.php`:
```php
<?php

use App\Models\User;
use Illuminate\Support\Facades\Http;
use Laravel\Sanctum\Sanctum;

beforeEach(function () {
    Http::fake([
        'api.themoviedb.org/*' => Http::response([
            'page' => 1,
            'total_pages' => 5,
            'total_results' => 100,
            'results' => [
                [
                    'id' => 603,
                    'title' => 'The Matrix',
                    'poster_path' => '/poster.jpg',
                    'release_date' => '1999-03-30',
                    'overview' => 'A computer hacker learns...',
                    'vote_average' => 8.7,
                ],
            ],
        ]),
    ]);
});

test('user can search for movies', function () {
    $user = User::factory()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson('/api/v1/media/search?type=movie&query=matrix');

    $response->assertStatus(200)
        ->assertJsonStructure([
            'data' => [
                '*' => ['external_id', 'title', 'poster_url', 'year', 'metadata'],
            ],
            'meta' => ['current_page', 'total_pages', 'total_results'],
        ]);
});

test('search requires type parameter', function () {
    $user = User::factory()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson('/api/v1/media/search?query=matrix');

    $response->assertStatus(422);
});

test('search requires query parameter', function () {
    $user = User::factory()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson('/api/v1/media/search?type=movie');

    $response->assertStatus(422);
});

test('search requires authentication', function () {
    $response = $this->getJson('/api/v1/media/search?type=movie&query=matrix');

    $response->assertStatus(401);
});

test('search validates type parameter', function () {
    $user = User::factory()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson('/api/v1/media/search?type=invalid&query=test');

    $response->assertStatus(422);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Feature/Media/MediaSearchTest.php
```
Expected: FAIL (route not found)

**Step 3: Commit test**

```bash
git add backend/tests/Feature/Media/MediaSearchTest.php
git commit -m "test: add media search feature tests"
```

---

## Task 2: Create MediaSearchController

**Step 1: Create controller**

Create `backend/app/Http/Controllers/Api/V1/MediaSearchController.php`:
```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use App\Services\Media\MediaSearchService;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class MediaSearchController extends Controller
{
    public function __construct(
        private MediaSearchService $mediaSearchService
    ) {}

    public function search(Request $request): JsonResponse
    {
        $request->validate([
            'type' => ['required', 'string', 'in:movie,tvshow,videogame,boardgame'],
            'query' => ['required', 'string', 'min:1'],
            'page' => ['nullable', 'integer', 'min:1'],
        ]);

        $results = $this->mediaSearchService->search(
            $request->type,
            $request->query('query'),
            $request->integer('page', 1)
        );

        return response()->json([
            'data' => collect($results->items)->map(fn ($item) => $item->toArray()),
            'meta' => [
                'current_page' => $results->currentPage,
                'total_pages' => $results->totalPages,
                'total_results' => $results->totalResults,
            ],
        ]);
    }

    public function show(Request $request, string $type, string $externalId): JsonResponse
    {
        $item = $this->mediaSearchService->getById($type, $externalId);

        if (!$item) {
            return response()->json([
                'error' => [
                    'code' => 'NOT_FOUND',
                    'message' => 'Media item not found.',
                ],
            ], 404);
        }

        return response()->json([
            'data' => $item->toArray(),
        ]);
    }
}
```

**Step 2: Commit controller**

```bash
git add backend/app/Http/Controllers/Api/V1/MediaSearchController.php
git commit -m "feat: add MediaSearchController"
```

---

## Task 3: Add Routes

**Step 1: Add media search routes**

Add to `backend/routes/api.php` inside the auth:sanctum middleware group:
```php
use App\Http\Controllers\Api\V1\MediaSearchController;

// Inside auth:sanctum middleware:
Route::get('media/search', [MediaSearchController::class, 'search']);
Route::get('media/{type}/{externalId}', [MediaSearchController::class, 'show']);
```

**Step 2: Run tests**

```bash
php artisan test tests/Feature/Media/MediaSearchTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/routes/api.php
git commit -m "feat: add media search routes"
```

---

## Phase 3.6 Completion Checklist

- [ ] Feature tests written (TDD)
- [ ] MediaSearchController with search() and show()
- [ ] Input validation for type, query, page
- [ ] Returns paginated results with meta
- [ ] Routes added under auth middleware
- [ ] 401 for unauthenticated requests
- [ ] 422 for validation errors
- [ ] All tests passing

---

## API Endpoints Created

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/v1/media/search | Search media by type |
| GET | /api/v1/media/{type}/{id} | Get media details |

---

## Next Sub-Phase

Proceed to **Phase 3.7: ElectionService** for election business logic.
