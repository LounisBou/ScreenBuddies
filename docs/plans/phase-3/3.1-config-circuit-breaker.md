# Phase 3.1: Config & Circuit Breaker

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create election and media configuration files, setup Ganesha circuit breaker.

**Architecture:** Config-driven external API integration with circuit breaker for resilience.

**Tech Stack:** Laravel Config, ackintosh/ganesha, Redis

**Prerequisites:** Phase 2 complete

**Reference:** `docs/plans/phase-3-election-system.md` Tasks 1 & 1.5, `docs/circuit-breaker.md`

---

## Task 1: Create Election Config

**Step 1: Create election config file**

Create `backend/config/election.php`:
```php
<?php

return [
    'candidates' => [
        'min' => 2,
        'max' => 30,
    ],
    'winners' => [
        'min' => 1,
        'max' => 5,
    ],
    'archive_after_hours' => 24,
];
```

**Step 2: Verify config loads**

Run: `php artisan tinker --execute="var_dump(config('election.candidates.min'));"`
Expected: `int(2)`

**Step 3: Commit**

```bash
git add backend/config/election.php
git commit -m "chore: add election config"
```

---

## Task 2: Create Media Config

**Step 1: Create media config file**

Create `backend/config/media.php`:
```php
<?php

return [
    'tmdb' => [
        'api_key' => env('TMDB_API_KEY'),
        'base_url' => 'https://api.themoviedb.org/3',
        'image_base_url' => 'https://image.tmdb.org/t/p/w500',
    ],
    'rawg' => [
        'api_key' => env('RAWG_API_KEY'),
        'base_url' => 'https://api.rawg.io/api',
    ],
    // Placeholder for future Board Game support (see docs/future-ideas.md)
    'bgg' => [
        'base_url' => 'https://boardgamegeek.com/xmlapi2',
    ],
    'cache_ttl' => [
        'search' => 3600, // 1 hour
        'details' => 86400, // 24 hours
    ],
];
```

**Step 2: Add env variables**

Add to `backend/.env.example`:
```env
TMDB_API_KEY=your-tmdb-key
RAWG_API_KEY=your-rawg-key
```

**Step 3: Commit**

```bash
git add backend/config/media.php backend/.env.example
git commit -m "chore: add media config with TMDB and RAWG settings"
```

---

## Task 3: Install Ganesha

**Step 1: Install Ganesha package**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
composer require ackintosh/ganesha
```

**Step 2: Commit**

```bash
git add composer.json composer.lock
git commit -m "chore: add ackintosh/ganesha circuit breaker"
```

---

## Task 4: Create Ganesha Config

**Step 1: Create ganesha config file**

Create `backend/config/ganesha.php`:
```php
<?php

return [
    'adapter' => env('GANESHA_ADAPTER', 'redis'),
    'redis' => [
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'port' => env('REDIS_PORT', 6379),
    ],
    'services' => [
        'tmdb' => [
            'failure_rate_threshold' => 50,  // Open circuit at 50% failure rate
            'interval_to_half_open' => 30,   // Try again after 30 seconds
            'minimum_requests' => 10,        // Need 10 requests before measuring
            'time_window' => 60,             // 60 second rolling window
        ],
        'rawg' => [
            'failure_rate_threshold' => 50,
            'interval_to_half_open' => 30,
            'minimum_requests' => 10,
            'time_window' => 60,
        ],
    ],
];
```

**Step 2: Commit**

```bash
git add backend/config/ganesha.php
git commit -m "chore: add Ganesha circuit breaker config"
```

---

## Task 5: Create GaneshaService

**Step 1: Create GaneshaService**

Create `backend/app/Services/CircuitBreaker/GaneshaService.php`:
```php
<?php

namespace App\Services\CircuitBreaker;

use Ackintosh\Ganesha;
use Ackintosh\Ganesha\Builder;
use Ackintosh\Ganesha\GuzzleMiddleware;
use Ackintosh\Ganesha\Storage\Adapter\Redis;
use GuzzleHttp\Client;
use GuzzleHttp\HandlerStack;

class GaneshaService
{
    private array $ganeshas = [];

    public function getHttpClient(string $serviceName): Client
    {
        $ganesha = $this->getGanesha($serviceName);

        $stack = HandlerStack::create();
        $stack->push(new GuzzleMiddleware($ganesha));

        return new Client(['handler' => $stack]);
    }

    public function isAvailable(string $serviceName): bool
    {
        return $this->getGanesha($serviceName)->isAvailable($serviceName);
    }

    public function getStatus(string $serviceName): string
    {
        $ganesha = $this->getGanesha($serviceName);
        return $ganesha->isAvailable($serviceName) ? 'closed' : 'open';
    }

    private function getGanesha(string $serviceName): Ganesha
    {
        if (!isset($this->ganeshas[$serviceName])) {
            $config = config("ganesha.services.$serviceName");

            $redis = new \Redis();
            $redis->connect(
                config('ganesha.redis.host'),
                config('ganesha.redis.port')
            );

            $this->ganeshas[$serviceName] = Builder::withRateStrategy()
                ->adapter(new Redis($redis))
                ->failureRateThreshold($config['failure_rate_threshold'])
                ->intervalToHalfOpen($config['interval_to_half_open'])
                ->minimumRequests($config['minimum_requests'])
                ->timeWindow($config['time_window'])
                ->build();
        }

        return $this->ganeshas[$serviceName];
    }
}
```

**Step 2: Commit**

```bash
git add backend/app/Services/CircuitBreaker/GaneshaService.php
git commit -m "feat: add GaneshaService for circuit breaker pattern"
```

---

## Task 6: Register GaneshaService

**Step 1: Add singleton binding**

Add to `backend/app/Providers/AppServiceProvider.php` register method:
```php
use App\Services\CircuitBreaker\GaneshaService;

public function register(): void
{
    $this->app->singleton(GaneshaService::class);
}
```

**Step 2: Commit**

```bash
git add backend/app/Providers/AppServiceProvider.php
git commit -m "chore: register GaneshaService singleton"
```

---

## Phase 3.1 Completion Checklist

- [ ] Election config created with candidate/winner limits
- [ ] Media config created with TMDB/RAWG settings
- [ ] Env variables added to .env.example
- [ ] Ganesha package installed
- [ ] Ganesha config with service-specific settings
- [ ] GaneshaService created with HTTP client factory
- [ ] GaneshaService registered as singleton

---

## Next Sub-Phase

Proceed to **Phase 3.2: Media DTOs & Interface** for data structures.
