# Phase 3.7: ElectionService

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create election business logic service with validation rules.

**Architecture:** Service handles create, close, list operations with config-driven validation.

**Tech Stack:** Laravel Service Layer, DB Transactions

**Prerequisites:** Phase 3.6 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 7

---

## Task 1: Write ElectionService Tests

**Step 1: Create test file**

Create `backend/tests/Unit/Services/Election/ElectionServiceTest.php`:
```php
<?php

use App\Models\User;
use App\Models\MediaType;
use App\Models\Election;
use App\Services\Election\ElectionService;
use App\Enums\ElectionStatus;

beforeEach(function () {
    $this->mediaType = MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('election service can create election', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $service = new ElectionService();

    $election = $service->create($user, [
        'title' => 'Movie Night',
        'media_type_code' => 'movie',
        'winner_count' => 2,
        'election_date' => now()->addDays(7),
        'deadline' => now()->addDays(6),
        'candidates' => [
            ['external_id' => 'tmdb:1', 'title' => 'Movie 1'],
            ['external_id' => 'tmdb:2', 'title' => 'Movie 2'],
            ['external_id' => 'tmdb:3', 'title' => 'Movie 3'],
        ],
    ]);

    expect($election)->toBeInstanceOf(Election::class);
    expect($election->status)->toBe(ElectionStatus::VOTING);
    expect($election->candidates)->toHaveCount(3);
});

test('election service validates minimum candidate count', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $service = new ElectionService();

    expect(fn () => $service->create($user, [
        'title' => 'Movie Night',
        'media_type_code' => 'movie',
        'winner_count' => 1,
        'election_date' => now()->addDays(7),
        'deadline' => now()->addDays(6),
        'candidates' => [
            ['external_id' => 'tmdb:1', 'title' => 'Movie 1'],
        ],
    ]))->toThrow(\App\Exceptions\ApiException::class);
});

test('election service validates winner count less than candidates', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $service = new ElectionService();

    expect(fn () => $service->create($user, [
        'title' => 'Movie Night',
        'media_type_code' => 'movie',
        'winner_count' => 3,
        'election_date' => now()->addDays(7),
        'deadline' => now()->addDays(6),
        'candidates' => [
            ['external_id' => 'tmdb:1', 'title' => 'Movie 1'],
            ['external_id' => 'tmdb:2', 'title' => 'Movie 2'],
            ['external_id' => 'tmdb:3', 'title' => 'Movie 3'],
        ],
    ]))->toThrow(\App\Exceptions\ApiException::class);
});

test('election service adds maestro as voter', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $service = new ElectionService();

    $election = $service->create($user, [
        'title' => 'Movie Night',
        'media_type_code' => 'movie',
        'winner_count' => 1,
        'election_date' => now()->addDays(7),
        'deadline' => now()->addDays(6),
        'candidates' => [
            ['external_id' => 'tmdb:1', 'title' => 'Movie 1'],
            ['external_id' => 'tmdb:2', 'title' => 'Movie 2'],
        ],
    ]);

    expect($election->voters)->toHaveCount(1);
    expect($election->voters->first()->user_id)->toBe($user->id);
});

test('election service can close election', function () {
    $user = User::factory()->create();
    $mediaType = MediaType::first();
    $election = Election::factory()->create([
        'maestro_id' => $user->id,
        'media_type_id' => $mediaType->id,
        'status' => ElectionStatus::VOTING,
    ]);

    $service = new ElectionService();
    $closedElection = $service->close($election);

    expect($closedElection->status)->toBe(ElectionStatus::ENDED);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Unit/Services/Election/ElectionServiceTest.php
```
Expected: FAIL (class not found)

**Step 3: Commit test**

```bash
git add backend/tests/Unit/Services/Election/ElectionServiceTest.php
git commit -m "test: add ElectionService tests"
```

---

## Task 2: Implement ElectionService

**Step 1: Create ElectionService class**

Create `backend/app/Services/Election/ElectionService.php`:
```php
<?php

namespace App\Services\Election;

use App\Enums\ElectionStatus;
use App\Exceptions\ApiException;
use App\Models\Candidate;
use App\Models\Election;
use App\Models\MediaType;
use App\Models\User;
use App\Models\Voter;
use Illuminate\Support\Facades\DB;

class ElectionService
{
    public function create(User $maestro, array $data): Election
    {
        $this->validateCandidates($data['candidates'] ?? []);
        $this->validateWinnerCount($data['winner_count'], count($data['candidates'] ?? []));

        $mediaType = MediaType::where('code', $data['media_type_code'])->firstOrFail();

        $status = isset($data['campaign_end']) && $data['campaign_end']
            ? ElectionStatus::CAMPAIGN
            : ElectionStatus::VOTING;

        return DB::transaction(function () use ($maestro, $data, $mediaType, $status) {
            $election = Election::create([
                'title' => $data['title'],
                'description' => $data['description'] ?? null,
                'media_type_id' => $mediaType->id,
                'maestro_id' => $maestro->id,
                'winner_count' => $data['winner_count'],
                'election_date' => $data['election_date'],
                'deadline' => $data['deadline'],
                'campaign_end' => $data['campaign_end'] ?? null,
                'allow_suggestions' => $data['allow_suggestions'] ?? false,
                'auto_approve' => $data['auto_approve'] ?? false,
                'status' => $status,
            ]);

            foreach ($data['candidates'] as $candidateData) {
                Candidate::create([
                    'election_id' => $election->id,
                    'external_id' => $candidateData['external_id'],
                    'title' => $candidateData['title'],
                    'poster_url' => $candidateData['poster_url'] ?? null,
                    'year' => $candidateData['year'] ?? null,
                    'metadata' => $candidateData['metadata'] ?? null,
                    'is_approved' => true,
                ]);
            }

            // Add maestro as voter
            Voter::create([
                'election_id' => $election->id,
                'user_id' => $maestro->id,
                'joined_at' => now(),
            ]);

            return $election->load(['candidates', 'voters', 'mediaType']);
        });
    }

    public function close(Election $election): Election
    {
        if ($election->status !== ElectionStatus::VOTING) {
            throw new ApiException(
                'INVALID_STATUS',
                'Election is not in voting status.',
                400
            );
        }

        $election->update(['status' => ElectionStatus::ENDED]);

        return $election->fresh();
    }

    public function getForUser(User $user): \Illuminate\Database\Eloquent\Collection
    {
        $asMaestro = Election::where('maestro_id', $user->id)->pluck('id');
        $asVoter = Voter::where('user_id', $user->id)->pluck('election_id');

        $electionIds = $asMaestro->merge($asVoter)->unique();

        return Election::whereIn('id', $electionIds)
            ->with(['mediaType', 'maestro'])
            ->withCount(['candidates', 'voters'])
            ->orderBy('created_at', 'desc')
            ->get();
    }

    private function validateCandidates(array $candidates): void
    {
        $min = config('election.candidates.min');
        $max = config('election.candidates.max');
        $count = count($candidates);

        if ($count < $min) {
            throw new ApiException(
                'INVALID_CANDIDATE_COUNT',
                "Minimum $min candidates required.",
                400
            );
        }

        if ($count > $max) {
            throw new ApiException(
                'INVALID_CANDIDATE_COUNT',
                "Maximum $max candidates allowed.",
                400
            );
        }
    }

    private function validateWinnerCount(int $winnerCount, int $candidateCount): void
    {
        $min = config('election.winners.min');
        $max = config('election.winners.max');

        if ($winnerCount < $min || $winnerCount > $max) {
            throw new ApiException(
                'INVALID_WINNER_COUNT',
                "Winner count must be between $min and $max.",
                400
            );
        }

        if ($winnerCount >= $candidateCount) {
            throw new ApiException(
                'INVALID_WINNER_COUNT',
                'Winner count must be less than candidate count.',
                400
            );
        }
    }
}
```

**Step 2: Run tests**

```bash
php artisan test tests/Unit/Services/Election/ElectionServiceTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/app/Services/Election/ElectionService.php
git commit -m "feat: add ElectionService"
```

---

## Phase 3.7 Completion Checklist

- [ ] ElectionService tests written (TDD)
- [ ] create() with DB transaction
- [ ] Validates candidate count (min: 2, max: 30)
- [ ] Validates winner count (1-5, less than candidates)
- [ ] Creates candidates in transaction
- [ ] Adds maestro as first voter
- [ ] close() changes status to ENDED
- [ ] getForUser() returns elections as maestro or voter
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 3.8: Election Controller** for CRUD endpoints.
