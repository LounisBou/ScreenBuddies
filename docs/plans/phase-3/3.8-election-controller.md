# Phase 3.8: Election Controller

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create election CRUD API endpoints with request validation and resources.

**Architecture:** Controller uses ElectionService, returns JSON resources, requires verified email.

**Tech Stack:** Laravel Form Requests, API Resources

**Prerequisites:** Phase 3.7 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 8

---

## Task 1: Write Election Feature Tests

**Step 1: Create test file**

Create `backend/tests/Feature/Election/ElectionTest.php`:
```php
<?php

use App\Models\User;
use App\Models\MediaType;
use App\Models\Election;
use App\Models\Voter;
use Laravel\Sanctum\Sanctum;

beforeEach(function () {
    MediaType::create([
        'code' => 'movie',
        'label' => 'media_type.movie',
        'api_source' => 'tmdb',
    ]);
});

test('verified user can create election', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->postJson('/api/v1/elections', [
            'title' => 'Movie Night',
            'media_type_code' => 'movie',
            'winner_count' => 2,
            'election_date' => now()->addDays(7)->toIso8601String(),
            'deadline' => now()->addDays(6)->toIso8601String(),
            'candidates' => [
                ['external_id' => 'tmdb:1', 'title' => 'Movie 1'],
                ['external_id' => 'tmdb:2', 'title' => 'Movie 2'],
                ['external_id' => 'tmdb:3', 'title' => 'Movie 3'],
            ],
        ]);

    $response->assertStatus(201)
        ->assertJsonPath('data.title', 'Movie Night')
        ->assertJsonPath('data.status', 'voting');
});

test('unverified user cannot create election', function () {
    $user = User::factory()->unverified()->create();
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->postJson('/api/v1/elections', [
            'title' => 'Movie Night',
            'media_type_code' => 'movie',
            'winner_count' => 1,
            'election_date' => now()->addDays(7)->toIso8601String(),
            'deadline' => now()->addDays(6)->toIso8601String(),
            'candidates' => [
                ['external_id' => 'tmdb:1', 'title' => 'Movie 1'],
                ['external_id' => 'tmdb:2', 'title' => 'Movie 2'],
            ],
        ]);

    $response->assertStatus(403);
});

test('user can list their elections', function () {
    $user = User::factory()->create();
    $election = Election::factory()->create(['maestro_id' => $user->id]);
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson('/api/v1/elections');

    $response->assertStatus(200)
        ->assertJsonCount(1, 'data');
});

test('user can view election they participate in', function () {
    $maestro = User::factory()->create();
    $voter = User::factory()->create();
    $election = Election::factory()->create(['maestro_id' => $maestro->id]);
    Voter::create([
        'election_id' => $election->id,
        'user_id' => $voter->id,
        'joined_at' => now(),
    ]);
    $token = $voter->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->getJson("/api/v1/elections/{$election->uuid}");

    $response->assertStatus(200);
});

test('maestro can close election', function () {
    $user = User::factory()->create(['email_verified_at' => now()]);
    $election = Election::factory()->create([
        'maestro_id' => $user->id,
        'status' => 'voting',
    ]);
    $token = $user->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->putJson("/api/v1/elections/{$election->uuid}/close");

    $response->assertStatus(200)
        ->assertJsonPath('data.status', 'ended');
});

test('non-maestro cannot close election', function () {
    $maestro = User::factory()->create();
    $otherUser = User::factory()->create(['email_verified_at' => now()]);
    $election = Election::factory()->create([
        'maestro_id' => $maestro->id,
        'status' => 'voting',
    ]);
    $token = $otherUser->createToken('access', ['access'])->plainTextToken;

    $response = $this->withHeader('Authorization', "Bearer $token")
        ->putJson("/api/v1/elections/{$election->uuid}/close");

    $response->assertStatus(403);
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Feature/Election/ElectionTest.php
```
Expected: FAIL

**Step 3: Commit test**

```bash
git add backend/tests/Feature/Election/ElectionTest.php
git commit -m "test: add election feature tests"
```

---

## Task 2: Create ElectionFactory

**Step 1: Create factory**

Create `backend/database/factories/ElectionFactory.php`:
```php
<?php

namespace Database\Factories;

use App\Enums\ElectionStatus;
use App\Models\MediaType;
use App\Models\User;
use Illuminate\Database\Eloquent\Factories\Factory;

class ElectionFactory extends Factory
{
    public function definition(): array
    {
        return [
            'title' => fake()->sentence(3),
            'description' => fake()->paragraph(),
            'media_type_id' => MediaType::first()?->id ?? MediaType::factory(),
            'maestro_id' => User::factory(),
            'winner_count' => fake()->numberBetween(1, 3),
            'election_date' => now()->addDays(7),
            'deadline' => now()->addDays(6),
            'campaign_end' => null,
            'allow_suggestions' => false,
            'auto_approve' => false,
            'status' => ElectionStatus::VOTING,
        ];
    }
}
```

**Step 2: Commit**

```bash
git add backend/database/factories/ElectionFactory.php
git commit -m "feat: add ElectionFactory"
```

---

## Task 3: Create CreateElectionRequest

**Step 1: Create form request**

Create `backend/app/Http/Requests/Election/CreateElectionRequest.php`:
```php
<?php

namespace App\Http\Requests\Election;

use Illuminate\Foundation\Http\FormRequest;

class CreateElectionRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true;
    }

    public function rules(): array
    {
        return [
            'title' => ['required', 'string', 'max:255'],
            'description' => ['nullable', 'string'],
            'media_type_code' => ['required', 'string', 'exists:media_types,code'],
            'winner_count' => ['required', 'integer', 'min:1', 'max:5'],
            'election_date' => ['required', 'date', 'after:deadline'],
            'deadline' => ['required', 'date', 'after:now'],
            'campaign_end' => ['nullable', 'date', 'before:deadline', 'after:now'],
            'allow_suggestions' => ['nullable', 'boolean'],
            'auto_approve' => ['nullable', 'boolean'],
            'candidates' => ['required', 'array', 'min:2', 'max:30'],
            'candidates.*.external_id' => ['required', 'string'],
            'candidates.*.title' => ['required', 'string'],
            'candidates.*.poster_url' => ['nullable', 'string', 'url'],
            'candidates.*.year' => ['nullable', 'integer'],
            'candidates.*.metadata' => ['nullable', 'array'],
        ];
    }
}
```

**Step 2: Commit**

```bash
git add backend/app/Http/Requests/Election/CreateElectionRequest.php
git commit -m "feat: add CreateElectionRequest"
```

---

## Task 4: Create API Resources

**Step 1: Create ElectionResource**

Create `backend/app/Http/Resources/ElectionResource.php`:
```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ElectionResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'uuid' => $this->uuid,
            'title' => $this->title,
            'media_type' => [
                'code' => $this->mediaType->code,
                'label' => __($this->mediaType->label),
            ],
            'status' => $this->status->value,
            'is_maestro' => $request->user()?->id === $this->maestro_id,
            'election_date' => $this->election_date->toIso8601String(),
            'deadline' => $this->deadline->toIso8601String(),
            'winner_count' => $this->winner_count,
            'candidate_count' => $this->candidates_count ?? $this->candidates->count(),
            'voter_count' => $this->voters_count ?? $this->voters->count(),
            'created_at' => $this->created_at->toIso8601String(),
        ];
    }
}
```

**Step 2: Create ElectionDetailResource**

Create `backend/app/Http/Resources/ElectionDetailResource.php`:
```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ElectionDetailResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'uuid' => $this->uuid,
            'title' => $this->title,
            'description' => $this->description,
            'media_type' => [
                'code' => $this->mediaType->code,
                'label' => __($this->mediaType->label),
            ],
            'maestro' => [
                'id' => $this->maestro->id,
                'display_name' => $this->maestro->display_name,
                'avatar_url' => $this->maestro->avatar_url,
            ],
            'status' => $this->status->value,
            'is_maestro' => $request->user()?->id === $this->maestro_id,
            'election_date' => $this->election_date->toIso8601String(),
            'deadline' => $this->deadline->toIso8601String(),
            'campaign_end' => $this->campaign_end?->toIso8601String(),
            'allow_suggestions' => $this->allow_suggestions,
            'auto_approve' => $this->auto_approve,
            'winner_count' => $this->winner_count,
            'candidates' => CandidateResource::collection($this->candidates),
            'voters' => VoterResource::collection($this->voters),
            'created_at' => $this->created_at->toIso8601String(),
        ];
    }
}
```

**Step 3: Create CandidateResource**

Create `backend/app/Http/Resources/CandidateResource.php`:
```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class CandidateResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'external_id' => $this->external_id,
            'title' => $this->title,
            'poster_url' => $this->poster_url,
            'year' => $this->year,
            'metadata' => $this->metadata,
            'is_approved' => $this->is_approved,
        ];
    }
}
```

**Step 4: Create VoterResource**

Create `backend/app/Http/Resources/VoterResource.php`:
```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class VoterResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'user' => [
                'id' => $this->user->id,
                'display_name' => $this->user->display_name,
                'avatar_url' => $this->user->avatar_url,
            ],
            'joined_at' => $this->joined_at->toIso8601String(),
            'completed' => $this->completed,
        ];
    }
}
```

**Step 5: Commit resources**

```bash
git add backend/app/Http/Resources/ElectionResource.php \
        backend/app/Http/Resources/ElectionDetailResource.php \
        backend/app/Http/Resources/CandidateResource.php \
        backend/app/Http/Resources/VoterResource.php
git commit -m "feat: add election API resources"
```

---

## Task 5: Create ElectionController

**Step 1: Create controller**

Create `backend/app/Http/Controllers/Api/V1/ElectionController.php`:
```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\Election\CreateElectionRequest;
use App\Http\Resources\ElectionDetailResource;
use App\Http\Resources\ElectionResource;
use App\Models\Election;
use App\Services\Election\ElectionService;
use App\Exceptions\ApiException;
use Illuminate\Http\JsonResponse;

class ElectionController extends Controller
{
    public function __construct(
        private ElectionService $electionService
    ) {}

    public function index(): JsonResponse
    {
        $elections = $this->electionService->getForUser(auth()->user());

        return response()->json([
            'data' => ElectionResource::collection($elections),
        ]);
    }

    public function store(CreateElectionRequest $request): JsonResponse
    {
        $election = $this->electionService->create(
            auth()->user(),
            $request->validated()
        );

        return response()->json([
            'data' => new ElectionDetailResource($election),
        ], 201);
    }

    public function show(string $uuid): JsonResponse
    {
        $election = Election::where('uuid', $uuid)
            ->with(['mediaType', 'maestro', 'candidates', 'voters.user'])
            ->firstOrFail();

        $this->authorizeView($election);

        return response()->json([
            'data' => new ElectionDetailResource($election),
        ]);
    }

    public function close(string $uuid): JsonResponse
    {
        $election = Election::where('uuid', $uuid)->firstOrFail();

        if ($election->maestro_id !== auth()->id()) {
            throw new ApiException(
                'FORBIDDEN',
                'Only the maestro can close the election.',
                403
            );
        }

        $election = $this->electionService->close($election);

        return response()->json([
            'data' => new ElectionDetailResource($election->load(['mediaType', 'maestro', 'candidates', 'voters.user'])),
        ]);
    }

    private function authorizeView(Election $election): void
    {
        $user = auth()->user();

        if ($election->maestro_id === $user->id) {
            return;
        }

        $isVoter = $election->voters()->where('user_id', $user->id)->exists();

        if (!$isVoter) {
            throw new ApiException(
                'FORBIDDEN',
                'You do not have access to this election.',
                403
            );
        }
    }
}
```

**Step 2: Commit controller**

```bash
git add backend/app/Http/Controllers/Api/V1/ElectionController.php
git commit -m "feat: add ElectionController"
```

---

## Task 6: Add Routes

**Step 1: Add election routes**

Add to `backend/routes/api.php`:
```php
use App\Http\Controllers\Api\V1\ElectionController;

// Inside auth:sanctum middleware:
// Elections (index and show don't require verified, store and close do)
Route::get('elections', [ElectionController::class, 'index']);
Route::get('elections/{uuid}', [ElectionController::class, 'show']);

// Inside verified middleware group:
Route::post('elections', [ElectionController::class, 'store']);
Route::put('elections/{uuid}/close', [ElectionController::class, 'close']);
```

**Step 2: Run tests**

```bash
php artisan test tests/Feature/Election/ElectionTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/routes/api.php
git commit -m "feat: add election routes"
```

---

## Phase 3.8 Completion Checklist

- [ ] Feature tests written (TDD)
- [ ] ElectionFactory created
- [ ] CreateElectionRequest with validation
- [ ] ElectionResource for list view
- [ ] ElectionDetailResource for detail view
- [ ] CandidateResource and VoterResource
- [ ] ElectionController with CRUD
- [ ] Verified middleware on create/close
- [ ] Authorization checks on show/close
- [ ] Routes added
- [ ] All tests passing

---

## API Endpoints Created

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | /api/v1/elections | List user's elections | Required |
| POST | /api/v1/elections | Create election | Verified |
| GET | /api/v1/elections/{uuid} | Get election details | Required |
| PUT | /api/v1/elections/{uuid}/close | Close election | Verified |

---

## Next Sub-Phase

Proceed to **Phase 3.9: Join Election System** for invite links.
