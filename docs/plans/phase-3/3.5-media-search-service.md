# Phase 3.5: MediaSearchService

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create unified media search facade that routes to appropriate provider.

**Architecture:** Service holds provider registry, routes by type, throws for invalid types.

**Tech Stack:** Laravel Service Layer

**Prerequisites:** Phase 3.4 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 5

---

## Task 1: Write MediaSearchService Tests

**Step 1: Create test file**

Create `backend/tests/Unit/Services/Media/MediaSearchServiceTest.php`:
```php
<?php

use App\Services\Media\MediaSearchService;
use Illuminate\Support\Facades\Http;

beforeEach(function () {
    Http::fake([
        'api.themoviedb.org/*' => Http::response([
            'page' => 1,
            'total_pages' => 1,
            'total_results' => 1,
            'results' => [
                ['id' => 1, 'title' => 'Test Movie', 'poster_path' => null, 'release_date' => '2024-01-01'],
            ],
        ]),
    ]);
});

test('media search service can search by type', function () {
    $service = new MediaSearchService();
    $results = $service->search('movie', 'test');

    expect($results->items)->toHaveCount(1);
});

test('media search service throws for invalid type', function () {
    $service = new MediaSearchService();

    expect(fn () => $service->search('invalid', 'test'))
        ->toThrow(\InvalidArgumentException::class);
});

test('media search service returns supported types', function () {
    $service = new MediaSearchService();
    $types = $service->getSupportedTypes();

    expect($types)->toContain('movie');
    expect($types)->toContain('tvshow');
    expect($types)->toContain('videogame');
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Unit/Services/Media/MediaSearchServiceTest.php
```
Expected: FAIL (class not found)

**Step 3: Commit test**

```bash
git add backend/tests/Unit/Services/Media/MediaSearchServiceTest.php
git commit -m "test: add MediaSearchService tests"
```

---

## Task 2: Implement MediaSearchService

**Step 1: Create MediaSearchService class**

Create `backend/app/Services/Media/MediaSearchService.php`:
```php
<?php

namespace App\Services\Media;

use App\Services\Media\Contracts\MediaProviderInterface;
use App\Services\Media\DTOs\MediaItem;
use App\Services\Media\DTOs\PaginatedResults;
use App\Services\Media\Providers\RawgProvider;
use App\Services\Media\Providers\TmdbProvider;
use InvalidArgumentException;

class MediaSearchService
{
    private array $providers = [];

    public function __construct()
    {
        $this->providers = [
            'movie' => new TmdbProvider('movie'),
            'tvshow' => new TmdbProvider('tvshow'),
            'videogame' => new RawgProvider(),
            // Placeholder: 'boardgame' => new BggProvider(), // See docs/future-ideas.md
        ];
    }

    public function search(string $type, string $query, int $page = 1): PaginatedResults
    {
        $provider = $this->getProvider($type);

        return $provider->search($query, $page);
    }

    public function getById(string $type, string $externalId): ?MediaItem
    {
        $provider = $this->getProvider($type);

        return $provider->getById($externalId);
    }

    public function getSupportedTypes(): array
    {
        return array_keys($this->providers);
    }

    private function getProvider(string $type): MediaProviderInterface
    {
        if (!isset($this->providers[$type])) {
            throw new InvalidArgumentException("Unsupported media type: $type");
        }

        return $this->providers[$type];
    }
}
```

**Step 2: Run tests**

```bash
php artisan test tests/Unit/Services/Media/MediaSearchServiceTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/app/Services/Media/MediaSearchService.php
git commit -m "feat: add MediaSearchService facade"
```

---

## Phase 3.5 Completion Checklist

- [ ] MediaSearchService tests written (TDD)
- [ ] Provider registry with movie, tvshow, videogame
- [ ] search() routes to correct provider
- [ ] getById() routes to correct provider
- [ ] getSupportedTypes() returns available types
- [ ] Throws InvalidArgumentException for unknown types
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 3.6: Media Search Controller** for API endpoints.
