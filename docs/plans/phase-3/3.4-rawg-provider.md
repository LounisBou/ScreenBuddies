# Phase 3.4: RAWG Provider

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create RAWG provider for video game search with caching and circuit breaker.

**Architecture:** Provider implements MediaProviderInterface, uses GaneshaService for HTTP, caches results.

**Tech Stack:** Guzzle, Laravel Cache, Ganesha

**Prerequisites:** Phase 3.3 complete

**Reference:** `docs/plans/phase-3-election-system.md` Task 4

---

## Task 1: Write RAWG Provider Tests

**Step 1: Create test file**

Create `backend/tests/Unit/Services/Media/RawgProviderTest.php`:
```php
<?php

use App\Services\Media\Providers\RawgProvider;
use App\Services\Media\DTOs\PaginatedResults;
use Illuminate\Support\Facades\Http;

test('rawg provider returns videogame type', function () {
    $provider = new RawgProvider();

    expect($provider->getType())->toBe('videogame');
});

test('rawg provider can search games', function () {
    Http::fake([
        'api.rawg.io/*' => Http::response([
            'count' => 100,
            'results' => [
                [
                    'id' => 3498,
                    'name' => 'Grand Theft Auto V',
                    'background_image' => 'https://example.com/gta5.jpg',
                    'released' => '2013-09-17',
                    'rating' => 4.47,
                    'genres' => [['name' => 'Action']],
                ],
            ],
        ]),
    ]);

    $provider = new RawgProvider();
    $results = $provider->search('gta');

    expect($results)->toBeInstanceOf(PaginatedResults::class);
    expect($results->items)->toHaveCount(1);
    expect($results->items[0]->title)->toBe('Grand Theft Auto V');
    expect($results->items[0]->externalId)->toBe('rawg:3498');
});
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/lounis/dev/ScreenBuddies/backend
php artisan test tests/Unit/Services/Media/RawgProviderTest.php
```
Expected: FAIL (class not found)

**Step 3: Commit test**

```bash
git add backend/tests/Unit/Services/Media/RawgProviderTest.php
git commit -m "test: add RAWG provider tests"
```

---

## Task 2: Implement RawgProvider

**Step 1: Create RawgProvider class**

Create `backend/app/Services/Media/Providers/RawgProvider.php`:
```php
<?php

namespace App\Services\Media\Providers;

use App\Exceptions\ApiException;
use App\Services\CircuitBreaker\GaneshaService;
use App\Services\Media\Contracts\MediaProviderInterface;
use App\Services\Media\DTOs\MediaItem;
use App\Services\Media\DTOs\PaginatedResults;
use GuzzleHttp\Exception\RequestException;
use Illuminate\Support\Facades\Cache;

class RawgProvider implements MediaProviderInterface
{
    private string $baseUrl;
    private string $apiKey;
    private GaneshaService $ganeshaService;

    public function __construct()
    {
        $this->baseUrl = config('media.rawg.base_url');
        $this->apiKey = config('media.rawg.api_key');
        $this->ganeshaService = app(GaneshaService::class);
    }

    public function getType(): string
    {
        return 'videogame';
    }

    public function search(string $query, int $page = 1): PaginatedResults
    {
        $cacheKey = "media:rawg:search:" . md5($query) . ":$page";
        $pageSize = 20;

        return Cache::remember($cacheKey, config('media.cache_ttl.search'), function () use ($query, $page, $pageSize) {
            try {
                $client = $this->ganeshaService->getHttpClient('rawg');
                $response = $client->get($this->baseUrl . '/games', [
                    'query' => [
                        'key' => $this->apiKey,
                        'search' => $query,
                        'page' => $page,
                        'page_size' => $pageSize,
                    ],
                ]);

                $data = json_decode($response->getBody()->getContents(), true);
            } catch (RequestException $e) {
                throw new ApiException(
                    'SERVICE_UNAVAILABLE',
                    'RAWG service is temporarily unavailable.',
                    503
                );
            }

            $totalResults = $data['count'] ?? 0;

            $items = array_map(
                fn ($item) => $this->mapToMediaItem($item),
                $data['results'] ?? []
            );

            return new PaginatedResults(
                items: $items,
                currentPage: $page,
                totalPages: (int) ceil($totalResults / $pageSize),
                totalResults: $totalResults
            );
        });
    }

    public function getById(string $externalId): ?MediaItem
    {
        $id = str_replace('rawg:', '', $externalId);
        $cacheKey = "media:rawg:item:$id";

        return Cache::remember($cacheKey, config('media.cache_ttl.details'), function () use ($id) {
            try {
                $client = $this->ganeshaService->getHttpClient('rawg');
                $response = $client->get($this->baseUrl . "/games/$id", [
                    'query' => ['key' => $this->apiKey],
                ]);

                $data = json_decode($response->getBody()->getContents(), true);
                return $this->mapToMediaItem($data);
            } catch (RequestException $e) {
                return null;
            }
        });
    }

    private function mapToMediaItem(array $data): MediaItem
    {
        return new MediaItem(
            externalId: 'rawg:' . $data['id'],
            title: $data['name'] ?? 'Unknown',
            posterUrl: $data['background_image'] ?? null,
            year: $this->extractYear($data['released'] ?? null),
            metadata: [
                'rating' => $data['rating'] ?? null,
                'genres' => array_map(fn ($g) => $g['name'], $data['genres'] ?? []),
                'platforms' => array_map(fn ($p) => $p['platform']['name'] ?? null, $data['platforms'] ?? []),
            ]
        );
    }

    private function extractYear(?string $date): ?int
    {
        if (!$date) {
            return null;
        }

        $parts = explode('-', $date);
        return isset($parts[0]) ? (int) $parts[0] : null;
    }
}
```

**Step 2: Run tests**

```bash
php artisan test tests/Unit/Services/Media/RawgProviderTest.php
```
Expected: PASS

**Step 3: Commit**

```bash
git add backend/app/Services/Media/Providers/RawgProvider.php
git commit -m "feat: add RAWG media provider"
```

---

## Phase 3.4 Completion Checklist

- [ ] RawgProvider tests written (TDD)
- [ ] RawgProvider implements MediaProviderInterface
- [ ] search() with caching (1 hour TTL)
- [ ] getById() with caching (24 hour TTL)
- [ ] Circuit breaker integration via GaneshaService
- [ ] Returns 'videogame' type
- [ ] Metadata includes genres and platforms
- [ ] All tests passing

---

## Next Sub-Phase

Proceed to **Phase 3.5: MediaSearchService** for unified search facade.
