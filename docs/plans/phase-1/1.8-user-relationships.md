# Phase 1.8: User Relationships

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add all relationships to User model now that dependent models exist.

**Architecture:** User has elections (as maestro), voters (participations), sent/received friend requests.

**Tech Stack:** Laravel 11, Eloquent, Pest

**Prerequisites:**
- Phase 1.7 complete (Voter model)

**Reference:** `docs/specifications/02-data-model.md`

---

## Task 1: Write User Relationships Test (TDD)

**Files:**
- Create: `backend/tests/Unit/Models/UserRelationshipsTest.php`

**Step 1: Create User relationships test**

Create `backend/tests/Unit/Models/UserRelationshipsTest.php`:
```php
<?php

use App\Models\User;

test('user has elections as maestro', function () {
    $user = new User();

    expect(method_exists($user, 'elections'))->toBeTrue();
});

test('user has voters (participations)', function () {
    $user = new User();

    expect(method_exists($user, 'voters'))->toBeTrue();
});

test('user has friendships sent and received', function () {
    $user = new User();

    expect(method_exists($user, 'sentFriendRequests'))->toBeTrue();
    expect(method_exists($user, 'receivedFriendRequests'))->toBeTrue();
});

test('user elections relationship returns HasMany', function () {
    $user = new User();
    $relation = $user->elections();

    expect($relation)->toBeInstanceOf(\Illuminate\Database\Eloquent\Relations\HasMany::class);
});

test('user voters relationship returns HasMany', function () {
    $user = new User();
    $relation = $user->voters();

    expect($relation)->toBeInstanceOf(\Illuminate\Database\Eloquent\Relations\HasMany::class);
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/UserRelationshipsTest.php
```

Expected: FAIL (methods don't exist)

---

## Task 2: Add Relationships to User Model

**Files:**
- Modify: `backend/app/Models/User.php`

**Step 1: Read current User model**

Read `backend/app/Models/User.php` to see current implementation.

**Step 2: Add relationship methods**

Add to `backend/app/Models/User.php` after existing methods:
```php
use Illuminate\Database\Eloquent\Relations\HasMany;

// Add these methods to the User class:

public function elections(): HasMany
{
    return $this->hasMany(Election::class, 'maestro_id');
}

public function voters(): HasMany
{
    return $this->hasMany(Voter::class);
}

public function sentFriendRequests(): HasMany
{
    return $this->hasMany(Friendship::class, 'requester_id');
}

public function receivedFriendRequests(): HasMany
{
    return $this->hasMany(Friendship::class, 'addressee_id');
}
```

Note: Make sure the `HasMany` import is added at the top of the file.

---

## Task 3: Run Tests

**Files:** None

**Step 1: Run User relationships tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/UserRelationshipsTest.php
```

Expected: All tests PASS

**Step 2: Run all model tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/
```

Expected: All tests PASS

**Step 3: Run all tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test
```

Expected: All tests PASS

---

## Task 4: Commit User Relationships

**Files:**
- `backend/app/Models/User.php`
- `backend/tests/Unit/Models/UserRelationshipsTest.php`

**Step 1: Stage and commit**

Run:
```bash
git add backend/ && git commit -m "feat: add User relationships (elections, voters, friendships)"
```

---

## Phase 1.8 Completion Checklist

- [ ] User relationships test written (TDD)
- [ ] elections() relationship added (HasMany to Election via maestro_id)
- [ ] voters() relationship added (HasMany to Voter)
- [ ] sentFriendRequests() relationship added (HasMany to Friendship via requester_id)
- [ ] receivedFriendRequests() relationship added (HasMany to Friendship via addressee_id)
- [ ] All model tests passing
- [ ] All tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 1.9: Seeders & Finalization** for database seeding and final verification.
