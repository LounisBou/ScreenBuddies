# Phase 1.5: Election Model

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create Election model - the core entity for voting sessions.

**Architecture:** Election with maestro (creator), media type, candidates, voters, status lifecycle.

**Tech Stack:** Laravel 11, PHP Enums, Eloquent, Pest

**Prerequisites:**
- Phase 1.4 complete (Friendship model)

**Reference:** `docs/specifications/02-data-model.md`

---

## Task 1: Create ElectionStatus Enum

**Files:**
- Create: `backend/app/Enums/ElectionStatus.php`

**Step 1: Create ElectionStatus enum**

Create `backend/app/Enums/ElectionStatus.php`:
```php
<?php

namespace App\Enums;

enum ElectionStatus: string
{
    case DRAFT = 'draft';
    case CAMPAIGN = 'campaign';
    case VOTING = 'voting';
    case ENDED = 'ended';
    case ARCHIVED = 'archived';
}
```

---

## Task 2: Write Election Model Test (TDD)

**Files:**
- Create: `backend/tests/Unit/Models/ElectionTest.php`

**Step 1: Create Election test**

Create `backend/tests/Unit/Models/ElectionTest.php`:
```php
<?php

use App\Models\Election;
use App\Enums\ElectionStatus;

test('election has required relationships', function () {
    $election = new Election();

    expect(method_exists($election, 'maestro'))->toBeTrue();
    expect(method_exists($election, 'mediaType'))->toBeTrue();
    expect(method_exists($election, 'candidates'))->toBeTrue();
    expect(method_exists($election, 'voters'))->toBeTrue();
});

test('election status is cast to enum', function () {
    $election = new Election();

    expect($election->getCasts())->toHaveKey('status');
});

test('election dates are cast to datetime', function () {
    $election = new Election();
    $casts = $election->getCasts();

    expect($casts)->toHaveKey('election_date');
    expect($casts)->toHaveKey('deadline');
});

test('election status enum has correct lifecycle values', function () {
    expect(ElectionStatus::DRAFT->value)->toBe('draft');
    expect(ElectionStatus::CAMPAIGN->value)->toBe('campaign');
    expect(ElectionStatus::VOTING->value)->toBe('voting');
    expect(ElectionStatus::ENDED->value)->toBe('ended');
    expect(ElectionStatus::ARCHIVED->value)->toBe('archived');
});

test('election generates uuid and invite_token on creation', function () {
    $election = new Election();

    // Boot should be called, triggering creating event
    expect($election->getFillable())->toContain('uuid')
        ->toContain('invite_token');
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/ElectionTest.php
```

Expected: FAIL (model doesn't exist)

---

## Task 3: Create Election Migration

**Files:**
- Create: `backend/database/migrations/xxxx_create_elections_table.php`

**Step 1: Generate migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan make:migration create_elections_table
```

**Step 2: Edit the migration**

Replace contents:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('elections', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->string('invite_token', 64)->unique();
            $table->string('title');
            $table->text('description')->nullable();
            $table->foreignId('media_type_id')->constrained('media_types');
            $table->foreignId('maestro_id')->constrained('users')->onDelete('cascade');
            $table->tinyInteger('winner_count')->default(1);
            $table->dateTime('election_date');
            $table->dateTime('deadline');
            $table->dateTime('campaign_end')->nullable();
            $table->boolean('allow_suggestions')->default(false);
            $table->boolean('auto_approve')->default(false);
            $table->string('status')->default('voting');
            $table->timestamps();

            $table->index('status');
            $table->index('deadline');
            $table->index('maestro_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('elections');
    }
};
```

---

## Task 4: Create Election Model

**Files:**
- Create: `backend/app/Models/Election.php`

**Step 1: Create Election model**

Create `backend/app/Models/Election.php`:
```php
<?php

namespace App\Models;

use App\Enums\ElectionStatus;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Support\Str;

class Election extends Model
{
    use HasFactory;

    protected $fillable = [
        'uuid',
        'invite_token',
        'title',
        'description',
        'media_type_id',
        'maestro_id',
        'winner_count',
        'election_date',
        'deadline',
        'campaign_end',
        'allow_suggestions',
        'auto_approve',
        'status',
    ];

    protected function casts(): array
    {
        return [
            'election_date' => 'datetime',
            'deadline' => 'datetime',
            'campaign_end' => 'datetime',
            'allow_suggestions' => 'boolean',
            'auto_approve' => 'boolean',
            'status' => ElectionStatus::class,
        ];
    }

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (Election $election) {
            if (empty($election->uuid)) {
                $election->uuid = Str::uuid();
            }
            if (empty($election->invite_token)) {
                $election->invite_token = Str::random(64);
            }
        });
    }

    public function maestro(): BelongsTo
    {
        return $this->belongsTo(User::class, 'maestro_id');
    }

    public function mediaType(): BelongsTo
    {
        return $this->belongsTo(MediaType::class);
    }

    public function candidates(): HasMany
    {
        return $this->hasMany(Candidate::class);
    }

    public function voters(): HasMany
    {
        return $this->hasMany(Voter::class);
    }
}
```

---

## Task 5: Run Migration and Tests

**Files:** None

**Step 1: Run migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan migrate
```

**Step 2: Run Election tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/ElectionTest.php
```

Expected: All tests PASS

---

## Task 6: Commit Election Model

**Files:**
- `backend/app/Enums/ElectionStatus.php`
- `backend/database/migrations/*elections*`
- `backend/app/Models/Election.php`
- `backend/tests/Unit/Models/ElectionTest.php`

**Step 1: Stage and commit**

Run:
```bash
git add backend/ && git commit -m "feat: add Election model with status enum"
```

---

## Phase 1.5 Completion Checklist

- [ ] ElectionStatus enum created (draft, campaign, voting, ended, archived)
- [ ] Election model test written (TDD)
- [ ] Election migration with indexes
- [ ] Election model with all relationships
- [ ] Auto-generate uuid and invite_token on creation
- [ ] Datetime casts for dates
- [ ] Tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 1.6: Candidate Model** for election candidates.
