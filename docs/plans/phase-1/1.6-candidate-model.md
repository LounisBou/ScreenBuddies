# Phase 1.6: Candidate Model

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create Candidate model for election items that voters choose between.

**Architecture:** Candidate belongs to Election, stores external API data and metadata.

**Tech Stack:** Laravel 11, Eloquent, Pest

**Prerequisites:**
- Phase 1.5 complete (Election model)

**Reference:** `docs/specifications/02-data-model.md`

---

## Task 1: Write Candidate Model Test (TDD)

**Files:**
- Create: `backend/tests/Unit/Models/CandidateTest.php`

**Step 1: Create Candidate test**

Create `backend/tests/Unit/Models/CandidateTest.php`:
```php
<?php

use App\Models\Candidate;

test('candidate belongs to election', function () {
    $candidate = new Candidate();

    expect(method_exists($candidate, 'election'))->toBeTrue();
});

test('candidate can have suggester', function () {
    $candidate = new Candidate();

    expect(method_exists($candidate, 'suggestedBy'))->toBeTrue();
});

test('candidate metadata is cast to array', function () {
    $candidate = new Candidate();

    expect($candidate->getCasts())->toHaveKey('metadata');
});

test('candidate has required fillable attributes', function () {
    $candidate = new Candidate();

    expect($candidate->getFillable())->toContain('external_id')
        ->toContain('title')
        ->toContain('poster_url')
        ->toContain('year')
        ->toContain('metadata');
});

test('candidate is_approved casts to boolean', function () {
    $candidate = new Candidate();

    expect($candidate->getCasts())->toHaveKey('is_approved');
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/CandidateTest.php
```

Expected: FAIL (model doesn't exist)

---

## Task 2: Create Candidate Migration

**Files:**
- Create: `backend/database/migrations/xxxx_create_candidates_table.php`

**Step 1: Generate migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan make:migration create_candidates_table
```

**Step 2: Edit the migration**

Replace contents:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('candidates', function (Blueprint $table) {
            $table->id();
            $table->foreignId('election_id')->constrained('elections')->onDelete('cascade');
            $table->string('external_id', 100);
            $table->string('title');
            $table->string('poster_url', 500)->nullable();
            $table->smallInteger('year')->nullable();
            $table->json('metadata')->nullable();
            $table->foreignId('suggested_by')->nullable()->constrained('users')->onDelete('set null');
            $table->boolean('is_approved')->default(true);
            $table->timestamps();

            $table->unique(['election_id', 'external_id']);
            $table->index('election_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('candidates');
    }
};
```

---

## Task 3: Create Candidate Model

**Files:**
- Create: `backend/app/Models/Candidate.php`

**Step 1: Create Candidate model**

Create `backend/app/Models/Candidate.php`:
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Candidate extends Model
{
    use HasFactory;

    protected $fillable = [
        'election_id',
        'external_id',
        'title',
        'poster_url',
        'year',
        'metadata',
        'suggested_by',
        'is_approved',
    ];

    protected function casts(): array
    {
        return [
            'metadata' => 'array',
            'is_approved' => 'boolean',
            'year' => 'integer',
        ];
    }

    public function election(): BelongsTo
    {
        return $this->belongsTo(Election::class);
    }

    public function suggestedBy(): BelongsTo
    {
        return $this->belongsTo(User::class, 'suggested_by');
    }
}
```

---

## Task 4: Run Migration and Tests

**Files:** None

**Step 1: Run migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan migrate
```

**Step 2: Run Candidate tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/CandidateTest.php
```

Expected: All tests PASS

---

## Task 5: Commit Candidate Model

**Files:**
- `backend/database/migrations/*candidates*`
- `backend/app/Models/Candidate.php`
- `backend/tests/Unit/Models/CandidateTest.php`

**Step 1: Stage and commit**

Run:
```bash
git add backend/ && git commit -m "feat: add Candidate model"
```

---

## Phase 1.6 Completion Checklist

- [ ] Candidate model test written (TDD)
- [ ] Candidate migration with unique constraint on election_id + external_id
- [ ] Candidate model with election and suggestedBy relationships
- [ ] metadata JSON cast
- [ ] is_approved boolean cast
- [ ] Tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 1.7: Voter Model** for election participants and vote storage.
