# Phase 1.7: Voter Model

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create Voter model for election participants with compact vote storage.

**Architecture:** Voter stores votes as JSON blob: `{"1_3": 1, "2_5": null}` where key is `smallerId_largerId` and value is winner ID or null (skipped).

**Tech Stack:** Laravel 11, Eloquent, Pest

**Prerequisites:**
- Phase 1.6 complete (Candidate model)

**Reference:** `docs/specifications/02-data-model.md`

---

## Task 1: Write Voter Model Test (TDD)

**Files:**
- Create: `backend/tests/Unit/Models/VoterTest.php`

**Step 1: Create Voter test**

Create `backend/tests/Unit/Models/VoterTest.php`:
```php
<?php

use App\Models\Voter;

test('voter belongs to election and user', function () {
    $voter = new Voter();

    expect(method_exists($voter, 'election'))->toBeTrue();
    expect(method_exists($voter, 'user'))->toBeTrue();
});

test('voter has votes JSON and duel_count', function () {
    $voter = new Voter();

    expect($voter->getCasts())->toHaveKey('votes');
    expect($voter->getFillable())->toContain('duel_count');
});

test('voter validates votes JSON format - valid votes', function () {
    $voter = new Voter();

    // Valid votes: smaller_larger format, winner is one of the pair
    $voter->votes = ['1_3' => 1, '2_5' => null, '4_7' => 7];
    expect($voter->votes)->toHaveKey('1_3');
});

test('voter validates votes JSON format - invalid key format', function () {
    $voter = new Voter();

    // Invalid key format (not digits_digits)
    expect(fn() => $voter->votes = ['abc' => 1])
        ->toThrow(InvalidArgumentException::class);
});

test('voter validates votes JSON format - invalid key ordering', function () {
    $voter = new Voter();

    // Invalid key ordering (larger_smaller)
    expect(fn() => $voter->votes = ['3_1' => 1])
        ->toThrow(InvalidArgumentException::class);
});

test('voter validates votes JSON format - invalid winner', function () {
    $voter = new Voter();

    // Invalid winner (not in pair)
    expect(fn() => $voter->votes = ['1_3' => 5])
        ->toThrow(InvalidArgumentException::class);
});

test('voter completed casts to boolean', function () {
    $voter = new Voter();

    expect($voter->getCasts())->toHaveKey('completed');
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/VoterTest.php
```

Expected: FAIL (model doesn't exist)

---

## Task 2: Create Voter Migration

**Files:**
- Create: `backend/database/migrations/xxxx_create_voters_table.php`

**Step 1: Generate migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan make:migration create_voters_table
```

**Step 2: Edit the migration**

Replace contents:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('voters', function (Blueprint $table) {
            $table->id();
            $table->foreignId('election_id')->constrained('elections')->onDelete('cascade');
            $table->foreignId('user_id')->constrained('users')->onDelete('cascade');
            $table->json('votes')->default('{}');  // Compact duel storage: {"1_2": 1, "1_3": 3, ...}
            $table->smallInteger('duel_count')->default(0);
            $table->timestamp('joined_at');
            $table->boolean('completed')->default(false);
            $table->timestamps();

            $table->unique(['election_id', 'user_id']);
            $table->index('election_id');
            $table->index('user_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('voters');
    }
};
```

---

## Task 3: Create Voter Model

**Files:**
- Create: `backend/app/Models/Voter.php`

**Step 1: Create Voter model**

Create `backend/app/Models/Voter.php`:
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Voter extends Model
{
    use HasFactory;

    protected $fillable = [
        'election_id',
        'user_id',
        'votes',
        'duel_count',
        'joined_at',
        'completed',
    ];

    protected function casts(): array
    {
        return [
            'votes' => 'array',  // JSON blob: {"1_2": 1, "1_3": 3, ...}
            'duel_count' => 'integer',
            'joined_at' => 'datetime',
            'completed' => 'boolean',
        ];
    }

    /**
     * Validate and set votes JSON.
     *
     * Vote format: {"smallerId_largerId": winnerId|null}
     * - Key must be digits_digits format
     * - First digit must be smaller than second
     * - Winner must be one of the two candidates or null (skipped)
     *
     * @throws \InvalidArgumentException if votes format is invalid
     */
    public function setVotesAttribute(array $votes): void
    {
        foreach ($votes as $key => $winnerId) {
            // 1. Validate key format (digits_digits)
            if (!preg_match('/^\d+_\d+$/', $key)) {
                throw new \InvalidArgumentException("Invalid vote key format: $key");
            }

            // 2. Validate smaller_larger ordering
            [$a, $b] = explode('_', $key);
            if ((int)$a >= (int)$b) {
                throw new \InvalidArgumentException("Vote key must be smaller_larger: $key");
            }

            // 3. Validate winner is one of the pair (or null for skip)
            if ($winnerId !== null && $winnerId != $a && $winnerId != $b) {
                throw new \InvalidArgumentException("Winner must be one of the candidates in pair $key: got $winnerId");
            }
        }

        $this->attributes['votes'] = json_encode($votes);
    }

    public function election(): BelongsTo
    {
        return $this->belongsTo(Election::class);
    }

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}
```

---

## Task 4: Run Migration and Tests

**Files:** None

**Step 1: Run migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan migrate
```

**Step 2: Run Voter tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/VoterTest.php
```

Expected: All tests PASS

---

## Task 5: Commit Voter Model

**Files:**
- `backend/database/migrations/*voters*`
- `backend/app/Models/Voter.php`
- `backend/tests/Unit/Models/VoterTest.php`

**Step 1: Stage and commit**

Run:
```bash
git add backend/ && git commit -m "feat: add Voter model with votes JSON validation"
```

---

## Phase 1.7 Completion Checklist

- [ ] Voter model test written (TDD)
- [ ] Voter migration with unique constraint on election_id + user_id
- [ ] Voter model with election and user relationships
- [ ] votes JSON cast with validation
- [ ] Vote key validation (smaller_larger format)
- [ ] Vote winner validation (must be in pair or null)
- [ ] completed boolean cast
- [ ] Tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 1.8: User Relationships** for adding relationships to User model.
