# Phase 1.2: User & UserPreference Models

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create User and UserPreference models with migrations and tests.

**Architecture:** User with Sanctum tokens, one-to-one relationship with UserPreference.

**Tech Stack:** Laravel 11, Eloquent, Pest

**Prerequisites:**
- Phase 1.1 complete (Sanctum installed)

**Reference:** `docs/specifications/02-data-model.md`

---

## Task 1: Write User Model Test (TDD)

**Files:**
- Create: `backend/tests/Unit/Models/UserTest.php`

**Step 1: Create User model test**

Create `backend/tests/Unit/Models/UserTest.php`:
```php
<?php

use App\Models\User;

test('user has required fillable attributes', function () {
    $user = new User();

    expect($user->getFillable())->toContain('email')
        ->toContain('password')
        ->toContain('display_name');
});

test('user has Sanctum tokens trait', function () {
    $user = new User();

    expect(method_exists($user, 'tokens'))->toBeTrue();
    expect(method_exists($user, 'createToken'))->toBeTrue();
});

test('user password is hidden', function () {
    $user = new User();

    expect($user->getHidden())->toContain('password');
});

test('user casts password to hashed', function () {
    $user = new User();

    expect($user->getCasts())->toHaveKey('password');
});

test('user has preference relationship', function () {
    $user = new User();

    expect(method_exists($user, 'preference'))->toBeTrue();
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/UserTest.php
```

Expected: FAIL (attributes not configured yet in default User model)

---

## Task 2: Update User Migration

**Files:**
- Modify: `backend/database/migrations/0001_01_01_000000_create_users_table.php`

**Step 1: Read current User migration**

Read `backend/database/migrations/0001_01_01_000000_create_users_table.php`.

**Step 2: Update User migration**

Replace contents of `backend/database/migrations/0001_01_01_000000_create_users_table.php`:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('email')->unique();
            $table->string('password');
            $table->string('display_name', 100)->nullable();
            $table->string('avatar_url', 500)->nullable();
            $table->timestamp('email_verified_at')->nullable();
            $table->boolean('is_admin')->default(false);
            $table->boolean('is_banned')->default(false);
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
    }
};
```

---

## Task 3: Update User Model

**Files:**
- Modify: `backend/app/Models/User.php`

**Step 1: Read current User model**

Read `backend/app/Models/User.php`.

**Step 2: Update User model**

Replace contents of `backend/app/Models/User.php`:
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\HasOne;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    use HasFactory, Notifiable, HasApiTokens;

    protected $fillable = [
        'email',
        'password',
        'display_name',
        'avatar_url',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
            'is_admin' => 'boolean',
            'is_banned' => 'boolean',
        ];
    }

    public function preference(): HasOne
    {
        return $this->hasOne(UserPreference::class);
    }
}
```

---

## Task 4: Run Fresh Migration

**Files:** None

**Step 1: Run fresh migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan migrate:fresh
```

Expected: All migrations run successfully

**Step 2: Verify users table columns**

Run:
```bash
psql screenbuddies -c '\d users' | head -20
```

Expected: New columns (display_name, avatar_url, is_admin, is_banned) listed

---

## Task 5: Run User Tests

**Files:** None

**Step 1: Run User model tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/UserTest.php
```

Expected: All tests PASS

---

## Task 6: Write UserPreference Model Test (TDD)

**Files:**
- Create: `backend/tests/Unit/Models/UserPreferenceTest.php`

**Step 1: Create UserPreference test**

Create `backend/tests/Unit/Models/UserPreferenceTest.php`:
```php
<?php

use App\Models\UserPreference;

test('user preference belongs to user', function () {
    $preference = new UserPreference();

    expect(method_exists($preference, 'user'))->toBeTrue();
});

test('user preference has notification settings', function () {
    $preference = new UserPreference();

    expect($preference->getFillable())->toContain('locale')
        ->toContain('notif_email')
        ->toContain('notif_push');
});

test('user preference casts booleans correctly', function () {
    $preference = new UserPreference();
    $casts = $preference->getCasts();

    expect($casts)->toHaveKey('notif_email')
        ->toHaveKey('notif_push');
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/UserPreferenceTest.php
```

Expected: FAIL (model doesn't exist)

---

## Task 7: Create UserPreference Migration

**Files:**
- Create: `backend/database/migrations/xxxx_create_user_preferences_table.php`

**Step 1: Generate migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan make:migration create_user_preferences_table
```

**Step 2: Edit the migration**

Find the newly created migration file and replace contents:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('user_preferences', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->unique()->constrained('users')->onDelete('cascade');
            $table->string('locale', 5)->default('en');
            $table->boolean('notif_email')->default(true);
            $table->boolean('notif_push')->default(true);
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('user_preferences');
    }
};
```

---

## Task 8: Create UserPreference Model

**Files:**
- Create: `backend/app/Models/UserPreference.php`

**Step 1: Create UserPreference model**

Create `backend/app/Models/UserPreference.php`:
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class UserPreference extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id',
        'locale',
        'notif_email',
        'notif_push',
    ];

    protected function casts(): array
    {
        return [
            'notif_email' => 'boolean',
            'notif_push' => 'boolean',
        ];
    }

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}
```

---

## Task 9: Run Migration and Tests

**Files:** None

**Step 1: Run migration**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan migrate
```

Expected: user_preferences table created

**Step 2: Run UserPreference tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test tests/Unit/Models/UserPreferenceTest.php
```

Expected: All tests PASS

**Step 3: Run all tests**

Run:
```bash
cd /Users/lounis/dev/ScreenBuddies/backend && php artisan test
```

Expected: All tests PASS

---

## Task 10: Commit User Models

**Files:**
- `backend/database/migrations/*users*`
- `backend/database/migrations/*user_preferences*`
- `backend/app/Models/User.php`
- `backend/app/Models/UserPreference.php`
- `backend/tests/Unit/Models/UserTest.php`
- `backend/tests/Unit/Models/UserPreferenceTest.php`

**Step 1: Check git status**

Run:
```bash
git status
```

**Step 2: Stage files**

Run:
```bash
git add backend/
```

**Step 3: Create commit**

Run:
```bash
git commit -m "$(cat <<'EOF'
feat: add User and UserPreference models

- User with Sanctum, email, display_name, avatar_url
- User admin/banned flags
- UserPreference with locale and notification settings
- One-to-one relationship
- Full test coverage
EOF
)"
```

---

## Phase 1.2 Completion Checklist

- [ ] User model test written (TDD)
- [ ] User migration updated with new fields
- [ ] User model updated with Sanctum, casts, relationships
- [ ] User tests passing
- [ ] UserPreference model test written (TDD)
- [ ] UserPreference migration created
- [ ] UserPreference model created
- [ ] UserPreference tests passing
- [ ] All tests passing
- [ ] Git commit created

---

## Next Sub-Phase

Proceed to **Phase 1.3: MediaType Model** for media type configuration.
