# Phase 6.1: Data Models

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create all data models for elections, candidates, media types, and duels.

**Architecture:** Equatable models with fromJson/toJson for API serialization.

**Tech Stack:** Dart, Equatable

**Prerequisites:** Phase 5 complete

**Reference:** `docs/plans/phase-6-flutter-election-features.md` Task 1

---

## Task 1: Create MediaType Model

**Step 1: Create media_type_model.dart**

Create `frontend/lib/data/models/media_type_model.dart`:
```dart
import 'package:equatable/equatable.dart';

class MediaType extends Equatable {
  final String code;
  final String label;

  const MediaType({
    required this.code,
    required this.label,
  });

  factory MediaType.fromJson(Map<String, dynamic> json) {
    return MediaType(
      code: json['code'] as String,
      label: json['label'] as String,
    );
  }

  Map<String, dynamic> toJson() => {
        'code': code,
        'label': label,
      };

  String get displayLabel {
    // Convert 'media_type.movie' to 'Movie'
    final parts = label.split('.');
    if (parts.length > 1) {
      return parts.last[0].toUpperCase() + parts.last.substring(1);
    }
    return label;
  }

  @override
  List<Object?> get props => [code, label];
}
```

**Step 2: Commit**

```bash
cd /Users/lounis/dev/ScreenBuddies
git add frontend/lib/data/models/media_type_model.dart
git commit -m "feat: add MediaType model"
```

---

## Task 2: Create Candidate Model

**Step 1: Create candidate_model.dart**

Create `frontend/lib/data/models/candidate_model.dart`:
```dart
import 'package:equatable/equatable.dart';

class Candidate extends Equatable {
  final int id;
  final String externalId;
  final String title;
  final String? posterUrl;
  final int? year;
  final Map<String, dynamic>? metadata;
  final bool isApproved;

  const Candidate({
    required this.id,
    required this.externalId,
    required this.title,
    this.posterUrl,
    this.year,
    this.metadata,
    this.isApproved = true,
  });

  factory Candidate.fromJson(Map<String, dynamic> json) {
    return Candidate(
      id: json['id'] as int,
      externalId: json['external_id'] as String,
      title: json['title'] as String,
      posterUrl: json['poster_url'] as String?,
      year: json['year'] as int?,
      metadata: json['metadata'] as Map<String, dynamic>?,
      isApproved: json['is_approved'] as bool? ?? true,
    );
  }

  Map<String, dynamic> toJson() => {
        'id': id,
        'external_id': externalId,
        'title': title,
        'poster_url': posterUrl,
        'year': year,
        'metadata': metadata,
        'is_approved': isApproved,
      };

  @override
  List<Object?> get props => [id, externalId, title];
}

/// Represents a media item from search results (not yet a candidate)
class MediaItem extends Equatable {
  final String externalId;
  final String title;
  final String? posterUrl;
  final int? year;
  final Map<String, dynamic>? metadata;

  const MediaItem({
    required this.externalId,
    required this.title,
    this.posterUrl,
    this.year,
    this.metadata,
  });

  factory MediaItem.fromJson(Map<String, dynamic> json) {
    return MediaItem(
      externalId: json['external_id'] as String,
      title: json['title'] as String,
      posterUrl: json['poster_url'] as String?,
      year: json['year'] as int?,
      metadata: json['metadata'] as Map<String, dynamic>?,
    );
  }

  Map<String, dynamic> toJson() => {
        'external_id': externalId,
        'title': title,
        'poster_url': posterUrl,
        'year': year,
        'metadata': metadata,
      };

  /// Convert to candidate for election creation
  Candidate toCandidate() {
    return Candidate(
      id: 0, // Will be assigned by backend
      externalId: externalId,
      title: title,
      posterUrl: posterUrl,
      year: year,
      metadata: metadata,
    );
  }

  @override
  List<Object?> get props => [externalId, title];
}
```

**Step 2: Commit**

```bash
git add frontend/lib/data/models/candidate_model.dart
git commit -m "feat: add Candidate and MediaItem models"
```

---

## Task 3: Create Election Model

**Step 1: Create election_model.dart**

Create `frontend/lib/data/models/election_model.dart`:
```dart
import 'package:equatable/equatable.dart';
import 'candidate_model.dart';
import 'media_type_model.dart';

enum ElectionStatus {
  draft,
  campaign,
  voting,
  ended,
  archived;

  static ElectionStatus fromString(String value) {
    return ElectionStatus.values.firstWhere(
      (e) => e.name == value.toLowerCase(),
      orElse: () => ElectionStatus.voting,
    );
  }

  bool get canVote => this == ElectionStatus.voting;
  bool get hasResults => this == ElectionStatus.ended || this == ElectionStatus.archived;
  bool get isActive => this == ElectionStatus.campaign || this == ElectionStatus.voting;
}

class Election extends Equatable {
  final int id;
  final String uuid;
  final String title;
  final String? description;
  final MediaType mediaType;
  final ElectionStatus status;
  final bool isMaestro;
  final DateTime electionDate;
  final DateTime deadline;
  final DateTime? campaignEnd;
  final int winnerCount;
  final int candidateCount;
  final int voterCount;
  final DateTime createdAt;

  const Election({
    required this.id,
    required this.uuid,
    required this.title,
    this.description,
    required this.mediaType,
    required this.status,
    required this.isMaestro,
    required this.electionDate,
    required this.deadline,
    this.campaignEnd,
    required this.winnerCount,
    required this.candidateCount,
    required this.voterCount,
    required this.createdAt,
  });

  factory Election.fromJson(Map<String, dynamic> json) {
    return Election(
      id: json['id'] as int,
      uuid: json['uuid'] as String,
      title: json['title'] as String,
      description: json['description'] as String?,
      mediaType: MediaType.fromJson(json['media_type'] as Map<String, dynamic>),
      status: ElectionStatus.fromString(json['status'] as String),
      isMaestro: json['is_maestro'] as bool? ?? false,
      electionDate: DateTime.parse(json['election_date'] as String),
      deadline: DateTime.parse(json['deadline'] as String),
      campaignEnd: json['campaign_end'] != null
          ? DateTime.parse(json['campaign_end'] as String)
          : null,
      winnerCount: json['winner_count'] as int,
      candidateCount: json['candidate_count'] as int? ?? 0,
      voterCount: json['voter_count'] as int? ?? 0,
      createdAt: DateTime.parse(json['created_at'] as String),
    );
  }

  Map<String, dynamic> toJson() => {
        'id': id,
        'uuid': uuid,
        'title': title,
        'description': description,
        'media_type': mediaType.toJson(),
        'status': status.name,
        'is_maestro': isMaestro,
        'election_date': electionDate.toIso8601String(),
        'deadline': deadline.toIso8601String(),
        'campaign_end': campaignEnd?.toIso8601String(),
        'winner_count': winnerCount,
        'candidate_count': candidateCount,
        'voter_count': voterCount,
        'created_at': createdAt.toIso8601String(),
      };

  @override
  List<Object?> get props => [id, uuid, title, status];
}

class ElectionDetail extends Election {
  final Maestro maestro;
  final List<Candidate> candidates;
  final List<Voter> voters;
  final bool allowSuggestions;
  final bool autoApprove;
  final String? inviteCode;

  const ElectionDetail({
    required super.id,
    required super.uuid,
    required super.title,
    super.description,
    required super.mediaType,
    required super.status,
    required super.isMaestro,
    required super.electionDate,
    required super.deadline,
    super.campaignEnd,
    required super.winnerCount,
    required super.candidateCount,
    required super.voterCount,
    required super.createdAt,
    required this.maestro,
    required this.candidates,
    required this.voters,
    required this.allowSuggestions,
    required this.autoApprove,
    this.inviteCode,
  });

  factory ElectionDetail.fromJson(Map<String, dynamic> json) {
    final candidatesList = json['candidates'] as List? ?? [];
    final votersList = json['voters'] as List? ?? [];

    return ElectionDetail(
      id: json['id'] as int,
      uuid: json['uuid'] as String,
      title: json['title'] as String,
      description: json['description'] as String?,
      mediaType: MediaType.fromJson(json['media_type'] as Map<String, dynamic>),
      status: ElectionStatus.fromString(json['status'] as String),
      isMaestro: json['is_maestro'] as bool? ?? false,
      electionDate: DateTime.parse(json['election_date'] as String),
      deadline: DateTime.parse(json['deadline'] as String),
      campaignEnd: json['campaign_end'] != null
          ? DateTime.parse(json['campaign_end'] as String)
          : null,
      winnerCount: json['winner_count'] as int,
      candidateCount: candidatesList.length,
      voterCount: votersList.length,
      createdAt: DateTime.parse(json['created_at'] as String),
      maestro: Maestro.fromJson(json['maestro'] as Map<String, dynamic>),
      candidates: candidatesList
          .map((c) => Candidate.fromJson(c as Map<String, dynamic>))
          .toList(),
      voters: votersList
          .map((v) => Voter.fromJson(v as Map<String, dynamic>))
          .toList(),
      allowSuggestions: json['allow_suggestions'] as bool? ?? false,
      autoApprove: json['auto_approve'] as bool? ?? false,
      inviteCode: json['invite_code'] as String?,
    );
  }
}

class Maestro extends Equatable {
  final int id;
  final String? displayName;
  final String? avatarUrl;

  const Maestro({
    required this.id,
    this.displayName,
    this.avatarUrl,
  });

  factory Maestro.fromJson(Map<String, dynamic> json) {
    return Maestro(
      id: json['id'] as int,
      displayName: json['display_name'] as String?,
      avatarUrl: json['avatar_url'] as String?,
    );
  }

  String get displayNameOrDefault => displayName ?? 'User #$id';

  @override
  List<Object?> get props => [id, displayName];
}

class Voter extends Equatable {
  final int id;
  final VoterUser user;
  final DateTime joinedAt;
  final int duelCount;
  final bool hasVoted;

  const Voter({
    required this.id,
    required this.user,
    required this.joinedAt,
    required this.duelCount,
    required this.hasVoted,
  });

  factory Voter.fromJson(Map<String, dynamic> json) {
    return Voter(
      id: json['id'] as int,
      user: VoterUser.fromJson(json['user'] as Map<String, dynamic>),
      joinedAt: DateTime.parse(json['joined_at'] as String),
      duelCount: json['duel_count'] as int? ?? 0,
      hasVoted: (json['duel_count'] as int? ?? 0) > 0,
    );
  }

  @override
  List<Object?> get props => [id, user];
}

class VoterUser extends Equatable {
  final int id;
  final String? displayName;
  final String? avatarUrl;

  const VoterUser({
    required this.id,
    this.displayName,
    this.avatarUrl,
  });

  factory VoterUser.fromJson(Map<String, dynamic> json) {
    return VoterUser(
      id: json['id'] as int,
      displayName: json['display_name'] as String?,
      avatarUrl: json['avatar_url'] as String?,
    );
  }

  String get displayNameOrDefault => displayName ?? 'User #$id';

  @override
  List<Object?> get props => [id, displayName];
}
```

**Step 2: Commit**

```bash
git add frontend/lib/data/models/election_model.dart
git commit -m "feat: add Election, ElectionDetail, Maestro, Voter models"
```

---

## Task 4: Create Duel Model

**Step 1: Create duel_model.dart**

Create `frontend/lib/data/models/duel_model.dart`:
```dart
import 'package:equatable/equatable.dart';
import 'candidate_model.dart';

class DuelProgress extends Equatable {
  final int completed;
  final int total;
  final double percentage;

  const DuelProgress({
    required this.completed,
    required this.total,
    required this.percentage,
  });

  factory DuelProgress.fromJson(Map<String, dynamic> json) {
    return DuelProgress(
      completed: json['completed'] as int,
      total: json['total'] as int,
      percentage: (json['percentage'] as num).toDouble(),
    );
  }

  bool get isComplete => completed >= total;

  @override
  List<Object?> get props => [completed, total, percentage];
}

class Duel extends Equatable {
  final Candidate candidateA;
  final Candidate candidateB;
  final DuelProgress progress;

  const Duel({
    required this.candidateA,
    required this.candidateB,
    required this.progress,
  });

  factory Duel.fromJson(Map<String, dynamic> json) {
    return Duel(
      candidateA: Candidate.fromJson(json['candidate_a'] as Map<String, dynamic>),
      candidateB: Candidate.fromJson(json['candidate_b'] as Map<String, dynamic>),
      progress: DuelProgress.fromJson(json['progress'] as Map<String, dynamic>),
    );
  }

  @override
  List<Object?> get props => [candidateA, candidateB, progress];
}

class VoteHistory extends Equatable {
  final int candidateAId;
  final int candidateBId;
  final int? winnerId;
  final DateTime votedAt;

  const VoteHistory({
    required this.candidateAId,
    required this.candidateBId,
    this.winnerId,
    required this.votedAt,
  });

  factory VoteHistory.fromJson(Map<String, dynamic> json) {
    return VoteHistory(
      candidateAId: json['candidate_a_id'] as int,
      candidateBId: json['candidate_b_id'] as int,
      winnerId: json['winner_id'] as int?,
      votedAt: DateTime.parse(json['voted_at'] as String),
    );
  }

  bool get wasSkipped => winnerId == null;

  @override
  List<Object?> get props => [candidateAId, candidateBId, winnerId];
}
```

**Step 2: Commit**

```bash
git add frontend/lib/data/models/duel_model.dart
git commit -m "feat: add Duel, DuelProgress, VoteHistory models"
```

---

## Models Summary

| Model | Properties | Purpose |
|-------|------------|---------|
| MediaType | code, label | Movie/TV/Game type |
| Candidate | id, externalId, title, posterUrl, year | Election candidate |
| MediaItem | externalId, title, posterUrl, year | Search result |
| Election | uuid, title, status, dates, counts | Election summary |
| ElectionDetail | + maestro, candidates, voters | Full election info |
| Maestro | id, displayName, avatarUrl | Election creator |
| Voter | id, user, joinedAt, duelCount | Election participant |
| Duel | candidateA, candidateB, progress | Voting pair |
| DuelProgress | completed, total, percentage | User voting progress |

---

## Phase 6.1 Completion Checklist

- [ ] media_type_model.dart
- [ ] candidate_model.dart with Candidate and MediaItem
- [ ] election_model.dart with Election, ElectionDetail, Maestro, Voter
- [ ] duel_model.dart with Duel, DuelProgress, VoteHistory
- [ ] All models have fromJson factory
- [ ] Equatable for value comparison
- [ ] All changes committed

---

## Next Sub-Phase

Proceed to **Phase 6.2: Elections Provider** for state management.
