# Phase 6.5: Election Widgets

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create reusable widgets for election cards, status badges, and offline indicators.

**Architecture:** Stateless widgets with theming support.

**Tech Stack:** Flutter Widgets, intl for date formatting

**Prerequisites:** Phase 6.4 complete

**Reference:** `docs/plans/phase-6-flutter-election-features.md` Tasks 5, 5.5

---

## Task 1: Create Election Status Badge

**Step 1: Create election_status_badge.dart**

Create `frontend/lib/presentation/widgets/election/election_status_badge.dart`:
```dart
import 'package:flutter/material.dart';
import '../../../data/models/election_model.dart';

class ElectionStatusBadge extends StatelessWidget {
  final ElectionStatus status;
  final bool compact;

  const ElectionStatusBadge({
    super.key,
    required this.status,
    this.compact = false,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: compact ? 8 : 12,
        vertical: compact ? 2 : 4,
      ),
      decoration: BoxDecoration(
        color: _getBackgroundColor(),
        borderRadius: BorderRadius.circular(compact ? 8 : 12),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (!compact) ...[
            Icon(
              _getIcon(),
              size: 14,
              color: _getTextColor(),
            ),
            const SizedBox(width: 4),
          ],
          Text(
            _getLabel(),
            style: TextStyle(
              color: _getTextColor(),
              fontSize: compact ? 10 : 12,
              fontWeight: FontWeight.w600,
            ),
          ),
        ],
      ),
    );
  }

  String _getLabel() {
    switch (status) {
      case ElectionStatus.draft:
        return 'Draft';
      case ElectionStatus.campaign:
        return 'Campaign';
      case ElectionStatus.voting:
        return 'Voting';
      case ElectionStatus.ended:
        return 'Ended';
      case ElectionStatus.archived:
        return 'Archived';
    }
  }

  IconData _getIcon() {
    switch (status) {
      case ElectionStatus.draft:
        return Icons.edit_note;
      case ElectionStatus.campaign:
        return Icons.campaign;
      case ElectionStatus.voting:
        return Icons.how_to_vote;
      case ElectionStatus.ended:
        return Icons.check_circle;
      case ElectionStatus.archived:
        return Icons.archive;
    }
  }

  Color _getBackgroundColor() {
    switch (status) {
      case ElectionStatus.draft:
        return Colors.grey.shade100;
      case ElectionStatus.campaign:
        return Colors.orange.shade100;
      case ElectionStatus.voting:
        return Colors.green.shade100;
      case ElectionStatus.ended:
        return Colors.blue.shade100;
      case ElectionStatus.archived:
        return Colors.grey.shade200;
    }
  }

  Color _getTextColor() {
    switch (status) {
      case ElectionStatus.draft:
        return Colors.grey.shade600;
      case ElectionStatus.campaign:
        return Colors.orange.shade800;
      case ElectionStatus.voting:
        return Colors.green.shade800;
      case ElectionStatus.ended:
        return Colors.blue.shade800;
      case ElectionStatus.archived:
        return Colors.grey.shade700;
    }
  }
}
```

**Step 2: Commit**

```bash
cd /Users/lounis/dev/ScreenBuddies
git add frontend/lib/presentation/widgets/election/election_status_badge.dart
git commit -m "feat: add election status badge widget"
```

---

## Task 2: Create Election Card

**Step 1: Create election_card.dart**

Create `frontend/lib/presentation/widgets/election/election_card.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../../core/theme/app_colors.dart';
import '../../../data/models/election_model.dart';
import 'election_status_badge.dart';

class ElectionCard extends StatelessWidget {
  final Election election;
  final VoidCallback? onTap;
  final bool showMaestroBadge;

  const ElectionCard({
    super.key,
    required this.election,
    this.onTap,
    this.showMaestroBadge = true,
  });

  @override
  Widget build(BuildContext context) {
    final dateFormat = DateFormat('MMM d, y');
    final timeFormat = DateFormat('h:mm a');

    return Card(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Title row with status badge
              Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Expanded(
                    child: Text(
                      election.title,
                      style: Theme.of(context).textTheme.titleMedium?.copyWith(
                            fontWeight: FontWeight.w600,
                          ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                  const SizedBox(width: 8),
                  ElectionStatusBadge(status: election.status),
                ],
              ),

              const SizedBox(height: 12),

              // Media type and voter count
              Row(
                children: [
                  // Media type
                  _buildInfoChip(
                    icon: _getMediaTypeIcon(election.mediaType.code),
                    label: election.mediaType.displayLabel,
                    context: context,
                  ),
                  const SizedBox(width: 12),

                  // Voter count
                  _buildInfoChip(
                    icon: Icons.people_outline,
                    label: '${election.voterCount} voter${election.voterCount != 1 ? 's' : ''}',
                    context: context,
                  ),

                  // Candidate count
                  if (election.candidateCount > 0) ...[
                    const SizedBox(width: 12),
                    _buildInfoChip(
                      icon: Icons.movie_outlined,
                      label: '${election.candidateCount}',
                      context: context,
                    ),
                  ],
                ],
              ),

              const SizedBox(height: 12),

              // Date info
              Row(
                children: [
                  Icon(
                    Icons.event,
                    size: 16,
                    color: AppColors.textTertiary,
                  ),
                  const SizedBox(width: 4),
                  Text(
                    '${dateFormat.format(election.electionDate)} at ${timeFormat.format(election.electionDate)}',
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          color: AppColors.textSecondary,
                        ),
                  ),
                ],
              ),

              // Deadline warning (if voting and close to deadline)
              if (election.status == ElectionStatus.voting &&
                  election.deadline.difference(DateTime.now()).inHours < 24) ...[
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: AppColors.warning.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.timer,
                        size: 14,
                        color: AppColors.warning,
                      ),
                      const SizedBox(width: 4),
                      Text(
                        'Deadline: ${_formatDeadline(election.deadline)}',
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                              color: AppColors.warning,
                              fontWeight: FontWeight.w500,
                            ),
                      ),
                    ],
                  ),
                ),
              ],

              // Maestro badge
              if (showMaestroBadge && election.isMaestro) ...[
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: AppColors.primary.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        Icons.star,
                        size: 14,
                        color: AppColors.primary,
                      ),
                      const SizedBox(width: 4),
                      Text(
                        'Maestro',
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                              color: AppColors.primary,
                              fontWeight: FontWeight.w500,
                            ),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildInfoChip({
    required IconData icon,
    required String label,
    required BuildContext context,
  }) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Icon(
          icon,
          size: 16,
          color: AppColors.textTertiary,
        ),
        const SizedBox(width: 4),
        Text(
          label,
          style: Theme.of(context).textTheme.bodySmall?.copyWith(
                color: AppColors.textSecondary,
              ),
        ),
      ],
    );
  }

  IconData _getMediaTypeIcon(String code) {
    switch (code) {
      case 'movie':
        return Icons.movie;
      case 'tvshow':
        return Icons.tv;
      case 'videogame':
        return Icons.sports_esports;
      case 'boardgame':
        return Icons.extension;
      case 'theater':
        return Icons.theater_comedy;
      default:
        return Icons.category;
    }
  }

  String _formatDeadline(DateTime deadline) {
    final diff = deadline.difference(DateTime.now());
    if (diff.inHours < 1) {
      return '${diff.inMinutes} min left';
    } else if (diff.inHours < 24) {
      return '${diff.inHours} hours left';
    } else {
      return DateFormat('MMM d, h:mm a').format(deadline);
    }
  }
}
```

**Step 2: Commit**

```bash
git add frontend/lib/presentation/widgets/election/election_card.dart
git commit -m "feat: add election card widget"
```

---

## Task 3: Create Offline UI Components

**Step 1: Create offline_banner.dart**

Create `frontend/lib/presentation/widgets/common/offline_banner.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/services/connectivity_service.dart';
import '../../../core/theme/app_colors.dart';

class OfflineBanner extends ConsumerWidget {
  final Widget? action;

  const OfflineBanner({super.key, this.action});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isOnline = ref.watch(isOnlineProvider);

    return isOnline.when(
      data: (online) => online
          ? const SizedBox.shrink()
          : Container(
              width: double.infinity,
              color: AppColors.warning,
              padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),
              child: Row(
                children: [
                  const Icon(
                    Icons.cloud_off,
                    color: Colors.white,
                    size: 18,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'You are offline',
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                            color: Colors.white,
                            fontWeight: FontWeight.w500,
                          ),
                    ),
                  ),
                  if (action != null) action!,
                ],
              ),
            ),
      loading: () => const SizedBox.shrink(),
      error: (_, __) => const SizedBox.shrink(),
    );
  }
}

/// Compact offline indicator (for app bar)
class OfflineIndicator extends ConsumerWidget {
  const OfflineIndicator({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isOnline = ref.watch(isOnlineProvider);

    return isOnline.when(
      data: (online) => online
          ? const SizedBox.shrink()
          : Container(
              padding: const EdgeInsets.all(4),
              decoration: BoxDecoration(
                color: AppColors.warning,
                shape: BoxShape.circle,
              ),
              child: const Icon(
                Icons.cloud_off,
                color: Colors.white,
                size: 16,
              ),
            ),
      loading: () => const SizedBox.shrink(),
      error: (_, __) => const SizedBox.shrink(),
    );
  }
}
```

**Step 2: Create last_updated_text.dart**

Create `frontend/lib/presentation/widgets/common/last_updated_text.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../../core/theme/app_colors.dart';

class LastUpdatedText extends StatelessWidget {
  final DateTime? cachedAt;
  final String prefix;

  const LastUpdatedText({
    super.key,
    this.cachedAt,
    this.prefix = 'Updated',
  });

  @override
  Widget build(BuildContext context) {
    if (cachedAt == null) return const SizedBox.shrink();

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            Icons.access_time,
            size: 12,
            color: AppColors.textTertiary,
          ),
          const SizedBox(width: 4),
          Text(
            '$prefix ${_formatRelativeTime(cachedAt!)}',
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
                  color: AppColors.textTertiary,
                ),
          ),
        ],
      ),
    );
  }

  String _formatRelativeTime(DateTime dateTime) {
    final now = DateTime.now();
    final difference = now.difference(dateTime);

    if (difference.inMinutes < 1) {
      return 'just now';
    } else if (difference.inMinutes < 60) {
      return '${difference.inMinutes} min ago';
    } else if (difference.inHours < 24) {
      final hours = difference.inHours;
      return '$hours hour${hours > 1 ? 's' : ''} ago';
    } else if (difference.inDays < 7) {
      final days = difference.inDays;
      return '$days day${days > 1 ? 's' : ''} ago';
    } else {
      return DateFormat.yMd().format(dateTime);
    }
  }
}
```

**Step 3: Commit**

```bash
git add frontend/lib/presentation/widgets/common/offline_banner.dart
git add frontend/lib/presentation/widgets/common/last_updated_text.dart
git commit -m "feat: add offline UI components"
```

---

## Task 4: Create Candidate Card Widget

**Step 1: Create candidate_card.dart**

Create `frontend/lib/presentation/widgets/candidate/candidate_card.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:cached_network_image/cached_network_image.dart';
import '../../../data/models/candidate_model.dart';

class CandidateCard extends StatelessWidget {
  final Candidate candidate;
  final VoidCallback? onTap;
  final VoidCallback? onRemove;
  final bool showRemoveButton;
  final bool compact;

  const CandidateCard({
    super.key,
    required this.candidate,
    this.onTap,
    this.onRemove,
    this.showRemoveButton = false,
    this.compact = false,
  });

  @override
  Widget build(BuildContext context) {
    if (compact) {
      return _buildCompact(context);
    }
    return _buildFull(context);
  }

  Widget _buildCompact(BuildContext context) {
    return Card(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: const EdgeInsets.all(8),
          child: Row(
            children: [
              // Poster
              ClipRRect(
                borderRadius: BorderRadius.circular(8),
                child: _buildPoster(width: 48, height: 72),
              ),
              const SizedBox(width: 12),

              // Info
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      candidate.title,
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                            fontWeight: FontWeight.w600,
                          ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    if (candidate.year != null)
                      Text(
                        candidate.year.toString(),
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                              color: Colors.grey,
                            ),
                      ),
                  ],
                ),
              ),

              // Remove button
              if (showRemoveButton && onRemove != null)
                IconButton(
                  icon: const Icon(Icons.close, size: 20),
                  onPressed: onRemove,
                  color: Colors.grey,
                ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildFull(BuildContext context) {
    return Card(
      clipBehavior: Clip.antiAlias,
      child: InkWell(
        onTap: onTap,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Poster
            AspectRatio(
              aspectRatio: 2 / 3,
              child: Stack(
                fit: StackFit.expand,
                children: [
                  _buildPoster(),
                  if (showRemoveButton && onRemove != null)
                    Positioned(
                      top: 8,
                      right: 8,
                      child: GestureDetector(
                        onTap: onRemove,
                        child: Container(
                          padding: const EdgeInsets.all(4),
                          decoration: BoxDecoration(
                            color: Colors.black54,
                            shape: BoxShape.circle,
                          ),
                          child: const Icon(
                            Icons.close,
                            size: 16,
                            color: Colors.white,
                          ),
                        ),
                      ),
                    ),
                ],
              ),
            ),

            // Info
            Padding(
              padding: const EdgeInsets.all(12),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    candidate.title,
                    style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                          fontWeight: FontWeight.w600,
                        ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  if (candidate.year != null) ...[
                    const SizedBox(height: 4),
                    Text(
                      candidate.year.toString(),
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                            color: Colors.grey,
                          ),
                    ),
                  ],
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPoster({double? width, double? height}) {
    if (candidate.posterUrl != null) {
      return CachedNetworkImage(
        imageUrl: candidate.posterUrl!,
        fit: BoxFit.cover,
        width: width,
        height: height,
        placeholder: (context, url) => Container(
          color: Colors.grey.shade200,
          child: const Center(
            child: CircularProgressIndicator(strokeWidth: 2),
          ),
        ),
        errorWidget: (context, url, error) => Container(
          color: Colors.grey.shade200,
          child: const Icon(Icons.movie, color: Colors.grey),
        ),
      );
    }

    return Container(
      width: width,
      height: height,
      color: Colors.grey.shade200,
      child: const Center(
        child: Icon(Icons.movie, size: 32, color: Colors.grey),
      ),
    );
  }
}
```

**Step 2: Commit**

```bash
git add frontend/lib/presentation/widgets/candidate/candidate_card.dart
git commit -m "feat: add candidate card widget"
```

---

## Phase 6.5 Completion Checklist

- [ ] election_status_badge.dart with colors per status
- [ ] election_card.dart with full election info
- [ ] offline_banner.dart for offline state
- [ ] OfflineIndicator for app bar
- [ ] last_updated_text.dart for cache age
- [ ] candidate_card.dart (compact and full versions)
- [ ] All widgets use theme colors
- [ ] All changes committed

---

## Next Sub-Phase

Proceed to **Phase 6.6: Home Screen Update** for elections list display.
