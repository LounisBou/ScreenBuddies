# Phase 5.5: Router

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create GoRouter configuration with auth-based redirects and route guards.

**Architecture:** Declarative routing with redirect logic based on auth state.

**Tech Stack:** GoRouter 13.x, Riverpod

**Prerequisites:** Phase 5.4 complete

**Reference:** `docs/plans/phase-5-flutter-foundation.md` Task 7

---

## Task 1: Create App Router

**Step 1: Create app_router.dart**

Create `frontend/lib/presentation/router/app_router.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../providers/auth_provider.dart';
import '../screens/splash_screen.dart';
import '../screens/auth/login_screen.dart';
import '../screens/auth/register_screen.dart';
import '../screens/home/home_screen.dart';

// Route names for type-safe navigation
class AppRoutes {
  static const splash = 'splash';
  static const login = 'login';
  static const register = 'register';
  static const home = 'home';

  // Route paths
  static const splashPath = '/splash';
  static const loginPath = '/auth/login';
  static const registerPath = '/auth/register';
  static const homePath = '/';
}

final routerProvider = Provider<GoRouter>((ref) {
  final authState = ref.watch(authProvider);

  return GoRouter(
    initialLocation: AppRoutes.splashPath,
    debugLogDiagnostics: true,
    refreshListenable: _AuthRefreshNotifier(ref),
    redirect: (context, state) {
      final isAuthenticated = authState.status == AuthStatus.authenticated;
      final isLoading = authState.status == AuthStatus.unknown;
      final currentPath = state.matchedLocation;

      // Paths that don't require auth
      final isAuthRoute = currentPath.startsWith('/auth');
      final isSplash = currentPath == AppRoutes.splashPath;

      // Still checking auth status - stay on splash
      if (isLoading) {
        return isSplash ? null : AppRoutes.splashPath;
      }

      // Not authenticated - redirect to login (unless already on auth route)
      if (!isAuthenticated && !isAuthRoute && !isSplash) {
        return AppRoutes.loginPath;
      }

      // Authenticated - redirect away from auth routes and splash
      if (isAuthenticated && (isAuthRoute || isSplash)) {
        return AppRoutes.homePath;
      }

      // No redirect needed
      return null;
    },
    routes: [
      // Splash
      GoRoute(
        path: AppRoutes.splashPath,
        name: AppRoutes.splash,
        builder: (context, state) => const SplashScreen(),
      ),

      // Auth routes
      GoRoute(
        path: AppRoutes.loginPath,
        name: AppRoutes.login,
        builder: (context, state) => const LoginScreen(),
      ),
      GoRoute(
        path: AppRoutes.registerPath,
        name: AppRoutes.register,
        builder: (context, state) => const RegisterScreen(),
      ),

      // Main app routes
      GoRoute(
        path: AppRoutes.homePath,
        name: AppRoutes.home,
        builder: (context, state) => const HomeScreen(),
      ),
    ],
    errorBuilder: (context, state) => Scaffold(
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline, size: 64, color: Colors.red),
            const SizedBox(height: 16),
            Text(
              'Page not found',
              style: Theme.of(context).textTheme.headlineSmall,
            ),
            const SizedBox(height: 8),
            Text(
              state.matchedLocation,
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    color: Colors.grey,
                  ),
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => context.go(AppRoutes.homePath),
              child: const Text('Go Home'),
            ),
          ],
        ),
      ),
    ),
  );
});

// Refresh notifier to trigger router refresh when auth state changes
class _AuthRefreshNotifier extends ChangeNotifier {
  _AuthRefreshNotifier(this._ref) {
    _ref.listen(authProvider, (previous, next) {
      // Only notify if status changed
      if (previous?.status != next.status) {
        notifyListeners();
      }
    });
  }

  final Ref _ref;
}
```

**Step 2: Commit**

```bash
cd /Users/lounis/dev/ScreenBuddies
git add frontend/lib/presentation/router/app_router.dart
git commit -m "feat: add GoRouter with auth redirects"
```

---

## Route Structure

| Route | Path | Auth Required | Description |
|-------|------|---------------|-------------|
| splash | /splash | No | Initial loading screen |
| login | /auth/login | No | Login screen |
| register | /auth/register | No | Registration screen |
| home | / | Yes | Main home screen |

---

## Redirect Logic

```
┌─────────────────────────────────────────────────┐
│              GoRouter redirect()                 │
└─────────────────┬───────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────┐
│         Check authState.status                   │
└─────────────────┬───────────────────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
    ▼             ▼             ▼
┌───────┐   ┌──────────┐  ┌────────────┐
│unknown│   │  auth'd  │  │ unauth'd   │
└───┬───┘   └────┬─────┘  └─────┬──────┘
    │            │              │
    ▼            │              │
┌────────┐       │              │
│→/splash│       │              │
└────────┘       │              │
                 │              │
         ┌───────┴───────┐      │
         │               │      │
         ▼               ▼      ▼
    ┌─────────┐    ┌─────────┐ ┌─────────────┐
    │on /auth │    │ on /    │ │  on /auth   │
    │or splash│    │ (home)  │ │  route?     │
    └────┬────┘    └────┬────┘ └──────┬──────┘
         │              │             │
         ▼              ▼         ┌───┴───┐
    ┌─────────┐    ┌─────────┐   │       │
    │ → /     │    │  null   │   ▼       ▼
    │ (home)  │    │(no redir)│ ┌────┐ ┌─────────┐
    └─────────┘    └─────────┘ │yes │ │  no     │
                               │null│ │→/auth   │
                               └────┘ │ /login  │
                                      └─────────┘
```

---

## Navigation Examples

**Programmatic Navigation:**
```dart
// Navigate to route
context.go(AppRoutes.homePath);

// Navigate with replacement (no back)
context.go(AppRoutes.loginPath);

// Push onto stack (allows back)
context.push('/elections/123');

// Pop current route
context.pop();

// Named route navigation
context.goNamed(AppRoutes.home);
```

**From Provider:**
```dart
// Access router from ref
final router = ref.read(routerProvider);
router.go(AppRoutes.homePath);
```

---

## Future Routes (Phase 6+)

```dart
// Election routes (to be added in Phase 6)
GoRoute(
  path: '/elections',
  name: 'elections',
  builder: (context, state) => const ElectionsScreen(),
  routes: [
    GoRoute(
      path: ':uuid',
      name: 'election-detail',
      builder: (context, state) {
        final uuid = state.pathParameters['uuid']!;
        return ElectionDetailScreen(uuid: uuid);
      },
      routes: [
        GoRoute(
          path: 'vote',
          name: 'election-vote',
          builder: (context, state) {
            final uuid = state.pathParameters['uuid']!;
            return VotingScreen(electionUuid: uuid);
          },
        ),
        GoRoute(
          path: 'results',
          name: 'election-results',
          builder: (context, state) {
            final uuid = state.pathParameters['uuid']!;
            return ResultsScreen(electionUuid: uuid);
          },
        ),
      ],
    ),
    GoRoute(
      path: 'create',
      name: 'create-election',
      builder: (context, state) => const CreateElectionScreen(),
    ),
  ],
),

// Join election via invite link
GoRoute(
  path: '/join/:inviteCode',
  name: 'join-election',
  builder: (context, state) {
    final inviteCode = state.pathParameters['inviteCode']!;
    return JoinElectionScreen(inviteCode: inviteCode);
  },
),

// User profile
GoRoute(
  path: '/profile',
  name: 'profile',
  builder: (context, state) => const ProfileScreen(),
),
```

---

## Phase 5.5 Completion Checklist

- [ ] app_router.dart created
- [ ] AppRoutes constants defined
- [ ] routerProvider with GoRouter
- [ ] Splash route
- [ ] Login route
- [ ] Register route
- [ ] Home route
- [ ] Redirect logic for auth state
- [ ] _AuthRefreshNotifier for state changes
- [ ] Error page builder
- [ ] All changes committed

---

## Next Sub-Phase

Proceed to **Phase 5.6: Auth Screens** for UI implementation.
